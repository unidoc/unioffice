//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_aa "archive/zip";_fgc "bufio";_aae "bytes";_fb "crypto/md5";_fba "encoding/hex";_bg "encoding/json";_ba "encoding/xml";_bf "errors";_gc "flag";_fg "fmt";_geb "github.com/stretchr/testify/require";_gcg "github.com/unidoc/unioffice/v2";
_be "github.com/unidoc/unipdf/v4/common";_ge "golang.org/x/image/font";_bdb "golang.org/x/image/font/opentype";_df "golang.org/x/image/math/fixed";_ae "image";_fc "image/color";_fca "image/draw";_b "image/png";_bc "io";_dd "io/ioutil";_aee "log";_f "math";
_bd "os";_g "os/exec";_c "path/filepath";_d "strings";_db "sync";_e "testing";_dde "time";);func _dfcg (_ada *_e .T ,_afbf string )int64 {_cgb ,_egf :=_bd .Stat (_afbf );_geb .NoError (_ada ,_egf );return _cgb .Size ();};func _dfb (_fbd ,_gcf string )error {_caab ,_ccfc :=_bd .Open (_fbd );
if _ccfc !=nil {return _ccfc ;};defer _caab .Close ();_eea ,_ ,_ccfc :=_ae .DecodeConfig (_caab );if _ccfc !=nil {panic (_ccfc );};_edce :=_ae .NewRGBA (_ae .Rect (0,0,_eea .Width ,_eea .Height ));_eeag ,_ccfc :=_bd .Create (_gcf );if _ccfc !=nil {return _ccfc ;
};defer _eeag .Close ();_ccfc =_b .Encode (_eeag ,_edce );if _ccfc !=nil {return _ccfc ;};return nil ;};func ReadPNG (file string )(_ae .Image ,error ){_cfd ,_ccf :=_bd .Open (file );if _ccf !=nil {return nil ,_ccf ;};defer _cfd .Close ();return _b .Decode (_cfd );
};func _cac (_fda *_e .T ,_bbg ,_gf []byte ){_beg :=_bba ("\u0065\u0078\u0070\u0065\u0063\u0074\u0065\u0064");_bd .WriteFile (_beg ,_bbg ,0644);_ab :=_bba ("\u0067\u006f\u0074");_bd .WriteFile (_ab ,_gf ,0644);defer func (){_bd .Remove (_beg );_bd .Remove (_ab )}();
_fbc (_beg );_fbc (_ab );_bda :=_g .Command ("\u0064\u0069\u0066\u0066","\u002d\u0075",_beg ,_ab );_bca ,_dga :=_bda .StdoutPipe ();if _dga !=nil {_fda .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_dga );
};defer _bca .Close ();_fbb ,_dga :=_bda .StderrPipe ();if _dga !=nil {_fda .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_dga );};defer _fbb .Close ();
if _ace :=_bda .Start ();_ace !=nil {_fda .Fatalf ("\u0065\u0072\u0072\u006f\u0072\u0020\u0073\u0074\u0072\u0069\u006eg\u0020\u0078\u006d\u006c\u0069\u006e\u0064\u0065\u006e\u0074:\u0020\u0025\u0073",_ace );};_ece :=_fgc .NewScanner (_bca );for _ece .Scan (){_aee .Println (_ece .Text ());
};if _fe :=_bda .Wait ();_fe !=nil {_fdg ,_ :=_bc .ReadAll (_fbb );_fda .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0077a\u0069\u0074\u0069\u006e\u0067\u0020o\u006e\u0020\u0078\u006d\u006c\u0069\u006ed\u0065\u006e\u0074\u003a\u0020\u0025\u0073\u0020\u005b\u0025s\u005d",string (_fdg ),_fe );
};};func CompareGoldenZip (t *_e .T ,expectedFn string ,got []byte ){_aed :=_c .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );if *_fd {if _eg :=_bd .WriteFile (_aed ,got ,0644);_eg !=nil {t .Fatal (_eg );};};CompareZip (t ,expectedFn ,got ,true );
};func (_bfg *ReferenceFile )Update (currentMap *ReferenceMap )error {if _bfg ._fcb ==""{return nil ;};_dgad :=_bfg .updateMap (currentMap );if _dgad ==0{return nil ;};_beaf ,_dce :=_bd .OpenFile (_bfg ._fcb ,_bd .O_CREATE |_bd .O_TRUNC |_bd .O_WRONLY ,0664);
if _dce !=nil {return _dce ;};defer _beaf .Close ();_bfg .Timestamp =_dde .Now ().UTC ();_gdf :=_bg .NewEncoder (_beaf );_gdf .SetIndent ("","\u0009");return _gdf .Encode (_bfg );};func CopyFile (src ,dst string )error {_cec ,_bbc :=_bd .Open (src );if _bbc !=nil {return _bbc ;
};defer _cec .Close ();_ed ,_bbc :=_bd .Create (dst );if _bbc !=nil {return _bbc ;};defer _ed .Close ();_ ,_bbc =_bc .Copy (_ed ,_cec );return _bbc ;};var _fd =_gc .Bool ("t\u0065\u0073\u0074\u002e\u0075\u0070\u0064\u0061\u0074\u0065",false ,"\u0075p\u0064a\u0074\u0065\u0020\u0067\u006fl\u0064\u0065n\u0020\u0066\u0069\u006c\u0065");
func _dff (_fbcb ,_afb _fc .Color )bool {_adc ,_dgea ,_bde ,_ceeg :=_fbcb .RGBA ();_abf ,_fde ,_ffe ,_cba :=_afb .RGBA ();return _adc ==_abf &&_dgea ==_fde &&_bde ==_ffe &&_ceeg ==_cba ;};func (_dee *ReferenceMap )MarshalJSON ()([]byte ,error ){return _bg .Marshal (_dee ._gce )};
type ValidationResult struct{File string `json:"file"`;Result bool `json:"result"`;Note string `json:"note"`;};func CompareImages (img1 ,img2 _ae .Image )(bool ,error ){_bfd :=img1 .Bounds ();_fdd :=0;for _cdf :=0;_cdf < _bfd .Size ().X ;_cdf ++{for _cgc :=0;
_cgc < _bfd .Size ().Y ;_cgc ++{_gdee ,_fag ,_cdb ,_ :=img1 .At (_cdf ,_cgc ).RGBA ();_edc ,_baed ,_ff ,_ :=img2 .At (_cdf ,_cgc ).RGBA ();if _gdee !=_edc ||_fag !=_baed ||_cdb !=_ff {_fdd ++;};};};_agc :=float64 (_fdd )/float64 (_bfd .Dx ()*_bfd .Dy ());
if _agc > 0.0001{_fg .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_agc ,_fdd );return false ,nil ;};return true ,nil ;};func _agg (_bcag *_ae .RGBA ,_cgfc string ,_ebf string ,_bcc ,_gec int )error {_bab ,_afe :=_dd .ReadFile (_cgfc );
if _afe !=nil {return _afe ;};_bcf ,_afe :=_bdb .Parse (_bab );if _afe !=nil {return _afe ;};_dgb ,_afe :=_bdb .NewFace (_bcf ,&_bdb .FaceOptions {Size :18,DPI :72,Hinting :_ge .HintingNone });if _afe !=nil {return _afe ;};_fee :=&_ge .Drawer {Dst :_bcag ,Src :_ae .NewUniform (_fc .RGBA {200,100,0,255}),Face :_dgb ,Dot :_df .P (_bcc ,_gec )};
_fee .DrawString (_ebf );return nil ;};func (_bbgg *ReferenceMap )Keys ()(_fea []string ){_fea =make ([]string ,len (_bbgg ._gce ));var _bbd int ;for _fcd :=range _bbgg ._gce {_fea [_bbd ]=_fcd ;_bbd ++;};return _fea ;};func RunRenderTest (t *_e .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ){RunRenderOfficeTest (t ,pdfPath ,outputDir ,baselineRenderPath ,saveBaseline ,currentHashMap ,refFile ,"\u002em\u0073\u0077\u006f\u0072\u0064");
};func _bba (_ac string )string {_agfg ,_ :=_bd .CreateTemp ("",_ac );defer _agfg .Close ();return _agfg .Name ();};type ReferenceFile struct{Timestamp _dde .Time `json:"timestamp"`;Map *ReferenceMap `json:"map,omitempty"`;_fcb string ;};func (_ad *ReferenceMap )Write (key string ,entry ReferenceEntry ){_ad .Lock ();
defer _ad .Unlock ();if _ad ._gce ==nil {_ad ._gce =map[string ]ReferenceEntry {};};_ad ._gce [key ]=entry ;};func CompareGoldenXML (t *_e .T ,expectedFn string ,got []byte ){_ag :=_c .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
if *_fd {if _ec :=_bd .WriteFile (_ag ,got ,0644);_ec !=nil {t .Fatal (_ec );};};_cc ,_fa :=_bd .ReadFile (_ag );if _fa !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065 \u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0065\u0078\u0070\u0065\u0063t\u0065\u0064\u0020\u0069\u006e\u0070\u0075t\u003a\u0020\u0025\u0073",_fa );
};_cac (t ,_cc ,got );};type ReferenceMap struct{_db .Mutex ;_gce map[string ]ReferenceEntry ;};var (ErrRenderNotSupported =_bf .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
ErrImageSizeNotMatch =_bf .New ("\u0069\u006d\u0061ge\u0020\u0073\u0069\u007a\u0065\u0073\u0020\u0064\u006f\u006e\u0027\u0074\u0020\u006d\u0061\u0074\u0063\u0068"););func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_fceg ,_cgf :=HashFile (file1 );
if _cgf !=nil {return false ,_cgf ;};_bbad ,_cgf :=HashFile (file2 );if _cgf !=nil {return false ,_cgf ;};if _fceg ==_bbad {return true ,nil ;};_gad ,_cgf :=ReadPNG (file1 );if _cgf !=nil {return false ,_cgf ;};_bee ,_cgf :=ReadPNG (file2 );if _cgf !=nil {return false ,_cgf ;
};if _gad .Bounds ()!=_bee .Bounds (){return false ,nil ;};return CompareImages (_gad ,_bee );};func (_egb *ReferenceMap )Copy ()*ReferenceMap {_eeb :=ReferenceMap {_gce :make (map[string ]ReferenceEntry ,len (_egb ._gce ))};for _dgd ,_gebg :=range _egb ._gce {_eeb ._gce [_dgd ]=_gebg ;
};return &_eeb ;};func ValidateDocument (file string )(bool ,error ){var (_egba =_bd .Getenv ("\u0050\u0052\u004fJ\u0045\u0043\u0054\u005f\u0052\u004f\u004f\u0054");_aad =_bd .Getenv ("\u0048\u004f\u004d\u0045")+"\u002f\u0064\u006f\u0074\u006e\u0065\u0074\u002f\u0064o\u0074\u006e\u0065\u0074";
_fecec =_egba +"\u002f\u002e\u0063\u0069\u002f\u006f\u0070\u0065\u006e\u0078\u006d\u006c\u002d\u0076\u0061l\u0069\u0064\u0061\u0074\u006f\u0072\u002f\u0062\u0069\u006e\u002f\u0052\u0065l\u0065\u0061\u0073\u0065\u002f\u006e\u0065\u0074\u0031\u0030\u002e\u0030/P\u0072\u006f\u0067\u0072\u0061\u006d\u002e\u0064\u006c\u006c";
_acg =_egba +"\u002f\u0069\u006et\u0065\u0072\u006e\u0061\u006c\u002f\u0074\u0065\u0073\u0074\u0075\u0074\u0069\u006c\u0073\u002f\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e\u005f\u0072\u0065s\u0075\u006c\u0074\u002e\u006a\u0073\u006f\u006e";
_efbe _aae .Buffer ;_efbf string ;_cabd =true ;);if _ ,_bddb :=_bd .Stat (_aad );_bddb !=nil {_be .Log .Debug ("\u0064\u006f\u0074\u006e\u0065\u0074 \u0065\u0078\u0065\u0063\u0075\u0074\u0061\u0062\u006c\u0065\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_aad );
return true ,nil ;};if _ ,_eaef :=_bd .Stat (_fecec );_eaef !=nil {_be .Log .Debug ("\u006f\u0070\u0065\u006e\u0078\u006dl\u002d\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u006f\u0072\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_fecec );
return true ,nil ;};var (_bgd map[string ]map[string ]*ValidationResult ;_ddc *ValidationResult ;);_bdc ,_edfd :=_bd .ReadFile (_acg );if _edfd !=nil {return false ,_edfd ;};if _gff :=_bg .Unmarshal (_bdc ,&_bgd );_gff !=nil {return false ,_gff ;};if _bgd ==nil {_bgd =make (map[string ]map[string ]*ValidationResult );
};_bgb :=_c .Ext (file );_bgb =_bgb [1:];if _bgb !="\u0064\u006f\u0063\u0078"&&_bgb !="\u0078\u006c\u0073\u0078"&&_bgb !="\u0070\u0070\u0074\u0078"{return false ,_fg .Errorf ("\u0075\u006e\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065d\u0020\u0066\u0069\u006c\u0065\u0020\u0065x\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u003a\u0020\u0025\u0073",_bgb );
};_fff :=_c .Base (file );if _ged ,_fccf :=_bgd [_bgb ];_fccf {if _cabg ,_ffg :=_ged [_fff ];_ffg {_ddc =_cabg ;};};_cfbg :=_g .Command (_aad ,_fecec ,"\u002d\u002d"+_bgb ,file );_cfbg .Stderr =&_efbe ;_caae ,_edfd :=_cfbg .Output ();if _edfd !=nil {_efbf =_efbe .String ();
};_ecgca :=string (_caae );_ecgca =_d .TrimSpace (_ecgca [_d .Index (_ecgca ,"\u000a")+1:]);if _d .Contains (_ecgca ,"\u0045x\u0063\u0065\u0070\u0074\u0069\u006fn")||_d .Contains (_ecgca ,"\u0069\u0073\u0020n\u006f\u0074\u0020\u0076\u0061\u006c\u0069\u0064"){_cabd =false ;
if _d .Contains (_ecgca ,"\u006da\u0069\u006e\u003a\u0073\u007a")||_d .Contains (_ecgca ,"m\u0061\u0069\u006e\u003a\u0066\u0061\u006d\u0069\u006c\u0079")||_d .Contains (_ecgca ,"\u0063h\u0061\u0072\u0074\u003a\u0065\u0078t"){_efbf ="\u0046\u0061\u0069\u006c\u0065\u0064\u0020\u0076\u0061\u006ci\u0064\u0061\u0074\u0069\u006f\u006e\u0020i\u0073\u0020\u0069\u0067\u006e\u006f\u0072\u0065\u0064\u003a\u0020"+_ecgca ;
_cabd =true ;};};if _efbf ==""{_efbf =_ecgca ;};if _ddc ==nil {_ddc =&ValidationResult {File :_fff ,Result :_cabd ,Note :_efbf };};_ddc .Result =_cabd ;_ddc .Note =_efbf ;if _bgd [_bgb ]==nil {_bgd [_bgb ]=make (map[string ]*ValidationResult );};if _abc ,_dgade :=_bgd [_bgb ][_fff ];
_dgade {if _abc .Result &&!_cabd {return false ,_fg .Errorf ("v\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e \u0072\u0065\u0073\u0075\u006c\u0074\u0020ch\u0061\u006e\u0067\u0065d\u0020\u0066\u006f\u0072\u0020\u0025\u0073\u003a\u0020%v\u0020\u002d>\u0020\u0025\u0076\u0020\u0028\u0025\u0073\u0029",file ,_abc .Result ,_cabd ,_efbf );
};};_bgd [_bgb ][_fff ]=_ddc ;_bdc ,_edfd =_bg .MarshalIndent (_bgd ,"","\u0020\u0020");if _edfd !=nil {return false ,_edfd ;};if _acgc :=_bd .WriteFile (_acg ,_bdc ,0644);_acgc !=nil {return false ,_acgc ;};return true ,nil ;};func (_fge *ReferenceMap )Len ()int {return len (_fge ._gce )};
func _dbfe (_eae ,_adb _ae .Rectangle )bool {return _eae .Min .X ==_adb .Min .X &&_eae .Min .Y ==_adb .Min .Y &&_eae .Max .X ==_adb .Max .X &&_eae .Max .Y ==_adb .Max .Y ;};func (_dded *ReferenceMap )Read (key string )(ReferenceEntry ,bool ){_dded .Lock ();
defer _dded .Unlock ();if _dded ._gce ==nil {return ReferenceEntry {},false ;};_cb ,_ecg :=_dded ._gce [key ];return _cb ,_ecg ;};func CombinePNGFiles (file1 ,file2 string )(bool ,error ){_fad ,_def :=ReadPNG (file1 );if _def !=nil {return false ,_def ;
};_bdac ,_def :=ReadPNG (file2 );if _def !=nil {return false ,_def ;};_ddb :=_ae .Point {_fad .Bounds ().Dx (),0};_ceb :=_ae .Rectangle {_ddb ,_ddb .Add (_bdac .Bounds ().Size ())};_gag :=_ae .Rectangle {_ae .Point {0,0},_ceb .Max };_cbg :=_ae .NewRGBA (_gag );
_fca .Draw (_cbg ,_fad .Bounds (),_fad ,_ae .Point {0,0},_fca .Src );_fca .Draw (_cbg ,_ceb ,_bdac ,_ae .Point {0,0},_fca .Src );_dbe :=_c .Dir (file1 );_fgg :=_d .TrimSuffix (_c .Base (file1 ),_c .Ext (file1 ));_cef ,_def :=_bd .Create (_dbe +"\u002f"+_fgg +"\u002d\u0063\u006f\u006d\u0062\u0069\u006e\u0065\u0064\u002e\u0070\u006e\u0067");
if _def !=nil {return false ,_def ;};defer _cef .Close ();if _cbb :=_b .Encode (_cef ,_cbg );_cbb !=nil {return false ,_cbb ;};return true ,nil ;};func (_fbg *ReferenceMap )UnmarshalJSON (data []byte )error {return _bg .Unmarshal (data ,&_fbg ._gce )};
func (_ebe *ReferenceFile )updateMap (_acd *ReferenceMap )int {var _fcfe int ;if _ebe .Map ._gce ==nil {_ebe .Map ._gce =map[string ]ReferenceEntry {};};for _aea ,_ea :=range _acd ._gce {_cg ,_egg :=_ebe .Map ._gce [_aea ];if !_egg {_ebe .Map ._gce [_aea ]=_ea ;
_fcfe ++;continue ;};if string (_cg .Value )!=string (_ea .Value ){_ebe .Map ._gce [_aea ]=_ea ;_fcfe ++;};};for _aaf :=range _ebe .Map ._gce {if _ ,_bdgf :=_acd ._gce [_aaf ];!_bdgf {delete (_ebe .Map ._gce ,_aaf );_fcfe ++;};};return _fcfe ;};func _bbf (_cd ,_de *_aa .Reader ,_af bool )func (_bdgg *_e .T ){return func (_ee *_e .T ){_age :=make ([]*_aa .File ,len (_cd .File ));
copy (_age ,_cd .File );_agf :=make ([]*_aa .File ,len (_de .File ));copy (_agf ,_de .File );if len (_age )!=len (_agf ){_ee .Errorf ("\u0065x\u0070\u0065\u0063\u0074e\u0064\u0020\u0025\u0064\u0020f\u0069l\u0065s\u002c\u0020\u0067\u006f\u0074\u0020\u0025d",len (_cd .File ),len (_de .File ));
};for _ca ,_cf :=range _age {for _eb ,_ef :=range _agf {if _ef ==nil {continue ;};if _cf .Name ==_ef .Name {if _af {_ee .Run (_cf .Name ,_ga (_cf ,_ef ));};_age [_ca ]=nil ;_agf [_eb ]=nil ;};};};for _ ,_dbg :=range _age {if _dbg !=nil {_ee .Errorf ("\u0064\u0069\u0064\u006e\u0027\u0074\u0020\u0066\u0069\u006ed\u0020\u0065\u0078\u0070\u0065\u0063\u0074e\u0064\u0020\u0066\u0069\u006c\u0065\u0020\u0027\u0025\u0073\u0027",_dbg .Name );
};};for _ ,_dc :=range _agf {if _dc !=nil {_ee .Errorf ("\u0066\u006f\u0075\u006e\u0064\u0020\u0075\u006e\u0065\u0078\u0070e\u0063\u0074\u0065\u0064\u0020\u0066\u0069\u006c\u0065\u0020'\u0025\u0073\u0027",_dc .Name );};};};};type ReferenceEntry struct{Timestamp int64 `json:"timestamp"`;
Value string `json:"value"`;ResultSize int64 `json:"resultSize,omitempty"`;DiffPercent float64 `json:"diffPercent,omitempty"`;DiffTotal float64 `json:"diffValue,omitempty"`;Invalid bool `json:"markedInvalid,omitempty"`;};func _ga (_fcf ,_dcc *_aa .File )func (_cca *_e .T ){return func (_caa *_e .T ){_egd ,_gdb :=_fcf .Open ();
if _gdb !=nil {_caa .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_fcf .Name );};defer _egd .Close ();_cae ,_gdb :=_dcc .Open ();if _gdb !=nil {_caa .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_dcc .Name );
};defer _cae .Close ();_gae ,_ :=_bc .ReadAll (_egd );_bcg ,_ :=_bc .ReadAll (_cae );if !_aae .Equal (_gae ,_bcg ){_cac (_caa ,_gae ,_bcg );_fg .Println (string (_gae ));_fg .Println (string (_bcg ));_caa .Errorf ("\u006d\u0069\u0073\u006da\u0074\u0063\u0068\u0065\u0064\u0020\u0063\u006f\u006e\u0074e\u006et\u0073\u0020\u0025\u0064\u0020\u0076\u0073 \u0025\u0064",len (_gae ),len (_bcg ));
};};};func HashFile (file string )(string ,error ){_da ,_aaa :=_bd .Open (file );if _aaa !=nil {return "",_aaa ;};defer _da .Close ();_dcf :=_fb .New ();if _ ,_aaa =_bc .Copy (_dcf ,_da );_aaa !=nil {return "",_aaa ;};return _fba .EncodeToString (_dcf .Sum (nil )),nil ;
};func CreatePNGDiff (src ,dst string )(bool ,string ,float64 ,float64 ,error ){_aag ,_baf :=ReadPNG (src );if _baf !=nil {return false ,"",0,0,_baf ;};_bag ,_baf :=ReadPNG (dst );if _baf !=nil {return false ,"",0,0,_baf ;};_gfg :=_aag .Bounds ();_dab :=_bag .Bounds ();
if !_dbfe (_gfg ,_dab ){if _f .Abs (float64 (_gfg .Max .X )-float64 (_dab .Max .X ))> 1{_aee .Printf ("S\u006f\u0075\u0072\u0063\u0065\u0020b\u006f\u0075\u006e\u0064\u0073\u003a \u0025\u0076\u003b\u0020\u0044\u0065\u0073t\u0020\u0062\u006f\u0075\u006e\u0064\u0073\u003a\u0020\u0025v\u000a",_gfg ,_dab );
return false ,"",0,0,ErrImageSizeNotMatch ;};};_acda :=_ae .NewRGBA (_ae .Rect (0,0,_gfg .Max .X ,_gfg .Max .Y ));var (_fec float64 ;_fece float64 ;);for _gcb :=_gfg .Min .Y ;_gcb < _gfg .Max .Y ;_gcb ++{for _dbf :=_gfg .Min .X ;_dbf < _gfg .Max .X ;_dbf ++{_ced ,_bce ,_eag ,_acdad :=_aag .At (_dbf ,_gcb ).RGBA ();
_edd ,_caf ,_aeb ,_efa :=_bag .At (_dbf ,_gcb ).RGBA ();_acda .Set (_dbf ,_gcb ,_fc .RGBA {uint8 (_edd ),uint8 (_caf ),uint8 (_aeb ),64});_bbgb :=_acdad ==0x00&&_ced ==0x00&&_bce ==0x00&&_eag ==0x00&&_edd ==0xFFFF&&_caf ==0xFFFF&&_aeb ==0xFFFF;if !_bbgb &&!_dff (_aag .At (_dbf ,_gcb ),_bag .At (_dbf ,_gcb )){_acda .Set (_dbf ,_gcb ,_fc .RGBA {uint8 (_ced ),uint8 (_bce ),uint8 (_eag ),uint8 (_acdad )});
_bdd :=float64 (_ced )+float64 (_bce )+float64 (_eag )+float64 (_acdad )-float64 (_edd )+float64 (_caf )+float64 (_aeb )+float64 (_efa );_agfge :=_f .Sqrt (_f .Pow (_bdd /float64 (_gfg .Dx ()*_gfg .Dy ()),2));_fece +=_agfge ;_fec ++;};};};_feb :=_fec /float64 (_gfg .Dx ()*_gfg .Dy ())*100;
_adg :=_c .Dir (src );_fbe :=_d .TrimSuffix (_c .Base (src ),_c .Ext (src ));_bcge ,_baf :=_bd .Create (_adg +"\u002f"+_fbe +"\u002dd\u0069\u0066\u0066\u002e\u0070\u006eg");if _baf !=nil {return false ,"",0,0,_baf ;};defer _bcge .Close ();_bgc :=_d .Replace (_adg ,"\u0072\u0065\u006e\u0064\u0065\u0072","\u0066\u006f\u006et\u0073",1)+"\u002f\u0043\u0061l\u0069\u0062\u0072\u0069\u002e\u0074\u0074\u0066";
_ggd :=_fg .Sprintf ("\u0044\u0069f\u0066\u0065\u0072e\u006e\u0063\u0065\u003a\u0020\u0025\u0066\u0025\u0025",_feb );_baf =_agg (_acda ,_bgc ,_ggd ,15,22);if _baf !=nil {return false ,"",0,0,_baf ;};_ggd =_fg .Sprintf ("T\u006ft\u0061\u006c\u0020\u0044\u0069\u0066\u0066\u0065r\u0065\u006e\u0063\u0065: \u0025\u0066",_fece );
_baf =_agg (_acda ,_bgc ,_ggd ,15,44);if _baf !=nil {return false ,"",0,0,_baf ;};if _bfc :=_b .Encode (_bcge ,_acda );_bfc !=nil {return false ,"",0,0,_bfc ;};return true ,_bcge .Name (),_feb ,_fece ,nil ;};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;
};if _ ,_fdc :=_g .LookPath ("\u0067\u0073");_fdc !=nil {return ErrRenderNotSupported ;};return _g .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_fg .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};func CompareGoldenZipFilesOnly (t *_e .T ,expectedFn string ,got []byte ){_bea :=_c .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );if *_fd {if _gca :=_bd .WriteFile (_bea ,got ,0644);_gca !=nil {t .Fatal (_gca );};};CompareZip (t ,expectedFn ,got ,false );
};func CompareZip (t *_e .T ,expectedFn string ,got []byte ,cmpFileContents bool ){_bdg :=_c .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );_gd ,_gg :=_aa .NewReader (_aae .NewReader (got ),int64 (len (got )));if _gg !=nil {t .Fatalf ("\u0075\u006ea\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0074\u0065\u0073\u0074\u0020\u0069\u006e\u0070\u0075\u0074: \u0025\u0073",_gg );
};_bb ,_gg :=_bd .Open (_bdg );if _gg !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020r\u0065\u0061\u0064\u0020\u0067\u006f\u006cd\u0065\u006e\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_gg );};defer _bb .Close ();
_fcc ,_gg :=_bd .Stat (_bdg );if _gg !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_gg );};_gga ,_gg :=_aa .NewReader (_bb ,_fcc .Size ());if _gg !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_gg );
};t .Run (expectedFn ,_bbf (_gga ,_gd ,cmpFileContents ));};func ReadFile (dirPath ,testName string ,createEmpty bool )(*ReferenceFile ,error ){if dirPath ==""&&createEmpty {return &ReferenceFile {Map :&ReferenceMap {}},nil ;};if dirPath ==""{return nil ,_bd .ErrNotExist ;
};_ecgc :=_c .Join (dirPath ,testName +"\u005fr\u0065f\u0065\u0072\u0065\u006e\u0063\u0065\u002e\u006a\u0073\u006f\u006e");_bae :=&ReferenceFile {_fcb :_ecgc };_efb ,_ccb :=_bd .Open (_ecgc );if _bf .Is (_ccb ,_bd .ErrNotExist )&&createEmpty {_bae .Timestamp =_dde .Now ().UTC ();
_bae .Map =&ReferenceMap {};return _bae ,nil ;};if _ccb !=nil {return nil ,_ccb ;};defer _efb .Close ();if _ebb :=_bg .NewDecoder (_efb ).Decode (_bae );_ebb !=nil {if _ebb .Error ()=="i\u006c\u006c\u0065\u0067\u0061\u006c \u0062\u0061\u0073\u0065\u0036\u0034 \u0064\u0061\u0074\u0061\u0020\u0061\u0074 \u0069\u006e\u0070\u0075\u0074\u0020\u0062\u0079\u0074\u0065 \u0030"&&createEmpty {return _bae ,nil ;
};return nil ,_ebb ;};return _bae ,nil ;};func _fbc (_dg string )error {_geg :=_gcg .XSDAny {};_ggaa ,_gde :=_bd .Open (_dg );if _gde !=nil {return _gde ;};_cce :=_ba .NewDecoder (_ggaa );if _gde =_cce .Decode (&_geg );_gde !=nil {return _gde ;};_ggaa .Close ();
_ggaa ,_gde =_bd .Create (_dg );if _gde !=nil {return _gde ;};defer _ggaa .Close ();_dge :=_ba .NewEncoder (_ggaa );_dge .Indent ("","\u0020\u0020");return _dge .Encode (&_geg );};func RunRenderOfficeTest (t *_e .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ,postfix string ){_agfa :=_d .TrimSuffix (_c .Base (pdfPath ),_c .Ext (pdfPath ));
t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_gdc *_e .T ){_bge :=_c .Join (outputDir ,_agfa );_dgec :=_bge +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _efc :=RenderPDFToPNGs (pdfPath ,0,_dgec );_efc !=nil {_gdc .Skip (_efc );};_baec :=_agfa +postfix ;
_febg :=_c .Join (outputDir ,_baec );_begf :=_febg +"\u002d%\u0064\u002e\u0070\u006e\u0067";_ffb :=false ;if saveBaseline {_bafa :=_c .Dir (pdfPath );_dfe :=_c .Join (_bafa ,_baec +"\u002e\u0070\u0064\u0066");if _ ,_agcc :=_bd .Stat (_dfe );_agcc ==nil {_gdc .Logf ("\u0052e\u006e\u0064\u0065\u0072\u0020\u004d\u0053\u0020\u004f\u0066\u0066i\u0063\u0065\u0020\u0050\u0044\u0046\u003a\u0020\u0025\u0076",_dfe );
if _daf :=RenderPDFToPNGs (_dfe ,0,_begf );_daf !=nil {_gdc .Skip (_daf );};_ffb =true ;};};for _egbe :=1;true ;_egbe ++{_ddbf :=_fg .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_bge ,_egbe );_gge :=_c .Join (baselineRenderPath ,_fg .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_agfa ,_egbe ));
if _ ,_cfb :=_bd .Stat (_ddbf );_cfb !=nil {break ;};_gdc .Logf ("\u0025\u0073",_gge );if saveBaseline {_gdc .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_ddbf ,_gge );_dcef :=CopyFile (_ddbf ,_gge );if _dcef !=nil {_gdc .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_gge ,_dcef );
};if _ffb {_aaag :=_fg .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_febg ,_egbe );_baa :=_c .Join (baselineRenderPath ,_fg .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_baec ,_egbe ));_gdc .Logf ("\u0043\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u004d\u0053\u0020\u0057\u006f\u0072\u0064 \u0072e\u0073\u0075\u006c\u0074\u0073\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_aaag ,_baa );
_edf :=CopyFile (_aaag ,_baa );if _edf !=nil {_gdc .Logf ("\u0045\u0052\u0052\u004f\u0052\u0020\u0063\u006f\u0070\u0079\u0069\u006eg\u0020\u0074\u006f \u0025\u0073\u003a\u0020\u0025\u0076\u002c\u0020\u0068\u0061\u0076i\u006e\u0067\u0020d\u0069\u0066\u0066\u0065r\u0065\u006e\u0074\u0020\u0070\u0061\u0067\u0065\u0020\u0073\u0069\u007a\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u002c\u0020\u0072\u0065\u0070\u006c\u0061\u0063\u0069\u006eg\u0020\u0069\u0074\u0020\u0077\u0069\u0074\u0068\u0020\u0062\u006ca\u006e\u006b\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0069\u006e\u0073\u0074\u0065\u0061\u0064",_baa ,_edf );
if _gfd :=_dfb (_gge ,_baa );_gfd !=nil {_gdc .Fatalf ("\u0045\u0052\u0052\u004f\u0052\u0020c\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0065\u006d\u0070\u0074\u0079 \u0069\u006d\u0061\u0067\u0065\u0020\u0025s\u003a\u0020\u0025\u0076",_baa ,_gfd );
};};_gdc .Logf ("\u0043\u006fm\u0062\u0069\u006e\u0069\u006eg\u0020\u0055\u006e\u0069\u004ff\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_gge ,_baa );
_bgea ,_edf :=CombinePNGFiles (_gge ,_baa );if _bd .IsNotExist (_edf ){_gdc .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_bgea {_gdc .Fatal ("\u0055n\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0063\u006f\u006db\u0069\u006e\u0065\u0020\u0069\u006d\u0061\u0067\u0065\u0073");
};_gdc .Logf ("\u0043\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0064\u0069\u0066f \u0055n\u0069\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075l\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065 \u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_gge ,_baa );
_bgea ,_dfc ,_gfc ,_cfc ,_edf :=CreatePNGDiff (_gge ,_baa );if _edf !=nil &&_bf .Is (_edf ,ErrImageSizeNotMatch ){_gdc .Fatalf ("\u0045\u0072\u0072\u006fr\u0020\u006f\u006e\u0020\u0063\u0072\u0065\u0061\u0074\u0065 \u0050N\u0047\u0020\u0044\u0069\u0066\u0066\u003a \u0025\u0076",_edf );
};if _bgea {_gdc .Logf ("\u0049\u006d\u0061\u0067\u0065\u003a\u0020\u0025\u0073\u000a",_dfc );_gdc .Logf ("D\u0069\u0066\u0066\u0020Pe\u0072c\u0065\u006e\u0074\u003a\u0020%\u0032\u002e\u0066\u0025\u0025\u000a",_gfc );_gdc .Logf ("\u0044i\u0066f\u0020\u0054\u006f\u0074\u0061\u006c\u003a\u0020\u0025\u0066\u000a",_cfc );
_eaa :=_c .Base (_dfc );_bfb ,_cab :=currentHashMap .Read (_eaa );if _cab &&(_bfb .DiffPercent < _gfc ||_bfb .DiffTotal < _cfc ){_gdc .Logf ("\u004e\u0065\u0077\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0068\u0061\u0076\u0069\u006e\u0067 h\u0069g\u0068\u0065\u0072\u0020\u0064\u0069\u0066\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0070\u0065\u0072\u0063\u0065\u006e\u0074\u003a\u0020\u0025\u0066\u0020\u0061\u006e\u0064 \u0074\u006f\u0074\u0061\u006c\u0020\u0025\u0066\u000a",_gfc ,_cfc );
};_gea ,_bcd :=HashFile (_dfc );_geb .NoError (_gdc ,_bcd );_beb :=_dfcg (_gdc ,_dfc );if !_cab ||_bfb .Value !=_gea ||_bfb .ResultSize !=_beb ||_bfb .DiffPercent !=_gfc ||_bfb .DiffTotal !=_cfc {_dag :=ReferenceEntry {Timestamp :_dde .Now ().UTC ().Unix (),Value :_gea ,ResultSize :_beb ,DiffPercent :_gfc ,DiffTotal :_cfc };
currentHashMap .Write (_eaa ,_dag );if _bcd =refFile .Update (currentHashMap );_bcd !=nil {_gdc .Logf ("\u0055\u0070\u0064\u0061\u0074\u0065\u0020\u0072\u0065\u0066\u0065\u0072\u0065\u006e\u0063e\u0020f\u0069\u006c\u0065\u0020\u0066\u0061\u0069\u006c\u0065\u0064\u003a\u0020\u0025\u0076",_bcd );
};};};};continue ;};_gdc .Run (_fg .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_egbe ),func (_bcfd *_e .T ){_bcfd .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_ddbf ,_gge );_cag ,_fbeb :=ComparePNGFiles (_ddbf ,_gge );
if _bd .IsNotExist (_fbeb ){_bcfd .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_cag {_bcfd .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};