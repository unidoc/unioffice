//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_f "archive/zip";_dg "bufio";_gff "bytes";_ea "crypto/md5";_ff "encoding/hex";_bd "encoding/json";_ac "encoding/xml";_cc "errors";_adg "flag";_ae "fmt";_eg "github.com/stretchr/testify/require";_de "github.com/unidoc/unioffice/v2";
_ba "github.com/unidoc/unipdf/v4/common";_bb "golang.org/x/image/font";_dc "golang.org/x/image/font/opentype";_eac "golang.org/x/image/math/fixed";_gf "image";_d "image/color";_e "image/draw";_b "image/png";_fac "io";_fc "io/ioutil";_eb "log";_g "math";
_ag "os";_be "os/exec";_df "path/filepath";_fa "strings";_ad "sync";_fca "testing";_c "time";);func CreatePNGDiff (src ,dst string )(bool ,string ,float64 ,float64 ,error ){_ccab ,_dfg :=ReadPNG (src );if _dfg !=nil {return false ,"",0,0,_dfg ;};_dgd ,_dfg :=ReadPNG (dst );
if _dfg !=nil {return false ,"",0,0,_dfg ;};_bgd :=_ccab .Bounds ();_gcc :=_dgd .Bounds ();if !_bbc (_bgd ,_gcc ){if _g .Abs (float64 (_bgd .Max .X )-float64 (_gcc .Max .X ))> 1{_eb .Printf ("S\u006f\u0075\u0072\u0063\u0065\u0020b\u006f\u0075\u006e\u0064\u0073\u003a \u0025\u0076\u003b\u0020\u0044\u0065\u0073t\u0020\u0062\u006f\u0075\u006e\u0064\u0073\u003a\u0020\u0025v\u000a",_bgd ,_gcc );
return false ,"",0,0,ErrImageSizeNotMatch ;};};_gbef :=_gf .NewRGBA (_gf .Rect (0,0,_bgd .Max .X ,_bgd .Max .Y ));var (_ggb float64 ;_bfgd float64 ;);for _aab :=_bgd .Min .Y ;_aab < _bgd .Max .Y ;_aab ++{for _ggg :=_bgd .Min .X ;_ggg < _bgd .Max .X ;_ggg ++{_bgb ,_gdc ,_eadd ,_dcb :=_ccab .At (_ggg ,_aab ).RGBA ();
_agb ,_cagb ,_gdf ,_dae :=_dgd .At (_ggg ,_aab ).RGBA ();_gbef .Set (_ggg ,_aab ,_d .RGBA {uint8 (_agb ),uint8 (_cagb ),uint8 (_gdf ),64});_cee :=_dcb ==0x00&&_bgb ==0x00&&_gdc ==0x00&&_eadd ==0x00&&_agb ==0xFFFF&&_cagb ==0xFFFF&&_gdf ==0xFFFF;if !_cee &&!_ceec (_ccab .At (_ggg ,_aab ),_dgd .At (_ggg ,_aab )){_gbef .Set (_ggg ,_aab ,_d .RGBA {uint8 (_bgb ),uint8 (_gdc ),uint8 (_eadd ),uint8 (_dcb )});
_bdfe :=float64 (_bgb )+float64 (_gdc )+float64 (_eadd )+float64 (_dcb )-float64 (_agb )+float64 (_cagb )+float64 (_gdf )+float64 (_dae );_gdeb :=_g .Sqrt (_g .Pow (_bdfe /float64 (_bgd .Dx ()*_bgd .Dy ()),2));_bfgd +=_gdeb ;_ggb ++;};};};_ccaa :=_ggb /float64 (_bgd .Dx ()*_bgd .Dy ())*100;
_gbag :=_df .Dir (src );_cdb :=_fa .TrimSuffix (_df .Base (src ),_df .Ext (src ));_egd ,_dfg :=_ag .Create (_gbag +"\u002f"+_cdb +"\u002dd\u0069\u0066\u0066\u002e\u0070\u006eg");if _dfg !=nil {return false ,"",0,0,_dfg ;};defer _egd .Close ();_fdf :=_fa .Replace (_gbag ,"\u0072\u0065\u006e\u0064\u0065\u0072","\u0066\u006f\u006et\u0073",1)+"\u002f\u0043\u0061l\u0069\u0062\u0072\u0069\u002e\u0074\u0074\u0066";
_ebc :=_ae .Sprintf ("\u0044\u0069f\u0066\u0065\u0072e\u006e\u0063\u0065\u003a\u0020\u0025\u0066\u0025\u0025",_ccaa );_dfg =_beec (_gbef ,_fdf ,_ebc ,15,22);if _dfg !=nil {return false ,"",0,0,_dfg ;};_ebc =_ae .Sprintf ("T\u006ft\u0061\u006c\u0020\u0044\u0069\u0066\u0066\u0065r\u0065\u006e\u0063\u0065: \u0025\u0066",_bfgd );
_dfg =_beec (_gbef ,_fdf ,_ebc ,15,44);if _dfg !=nil {return false ,"",0,0,_dfg ;};if _gge :=_b .Encode (_egd ,_gbef );_gge !=nil {return false ,"",0,0,_gge ;};return true ,_egd .Name (),_ccaa ,_bfgd ,nil ;};func RunRenderTest (t *_fca .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ){RunRenderOfficeTest (t ,pdfPath ,outputDir ,baselineRenderPath ,saveBaseline ,currentHashMap ,refFile ,"\u002em\u0073\u0077\u006f\u0072\u0064");
};var (ErrRenderNotSupported =_cc .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
ErrImageSizeNotMatch =_cc .New ("\u0069\u006d\u0061ge\u0020\u0073\u0069\u007a\u0065\u0073\u0020\u0064\u006f\u006e\u0027\u0074\u0020\u006d\u0061\u0074\u0063\u0068"););func _gae (_egee *_fca .T ,_bgc string )int64 {_dcf ,_efd :=_ag .Stat (_bgc );_eg .NoError (_egee ,_efd );
return _dcf .Size ();};func _ceec (_fgf ,_fag _d .Color )bool {_ddf ,_gca ,_cebc ,_dgde :=_fgf .RGBA ();_dcbg ,_gdff ,_bfd ,_fcc :=_fag .RGBA ();return _ddf ==_dcbg &&_gca ==_gdff &&_cebc ==_bfd &&_dgde ==_fcc ;};type ReferenceFile struct{Timestamp _c .Time `json:"timestamp"`;
Map *ReferenceMap `json:"map,omitempty"`;_bbaa string ;};func (_fdb *ReferenceMap )Len ()int {return len (_fdb ._gdg )};func (_ffa *ReferenceMap )UnmarshalJSON (data []byte )error {return _bd .Unmarshal (data ,&_ffa ._gdg )};func _egc (_ec *_fca .T ,_cdf ,_ffb []byte ){_gfb :=_cca ("\u0065\u0078\u0070\u0065\u0063\u0074\u0065\u0064");
_ag .WriteFile (_gfb ,_cdf ,0644);_gg :=_cca ("\u0067\u006f\u0074");_ag .WriteFile (_gg ,_ffb ,0644);defer func (){_ag .Remove (_gfb );_ag .Remove (_gg )}();_ef (_gfb );_ef (_gg );_ecb :=_be .Command ("\u0064\u0069\u0066\u0066","\u002d\u0075",_gfb ,_gg );
_ddd ,_cf :=_ecb .StdoutPipe ();if _cf !=nil {_ec .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_cf );};defer _ddd .Close ();_fda ,_cf :=_ecb .StderrPipe ();
if _cf !=nil {_ec .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_cf );};defer _fda .Close ();if _ddg :=_ecb .Start ();_ddg !=nil {_ec .Fatalf ("\u0065\u0072\u0072\u006f\u0072\u0020\u0073\u0074\u0072\u0069\u006eg\u0020\u0078\u006d\u006c\u0069\u006e\u0064\u0065\u006e\u0074:\u0020\u0025\u0073",_ddg );
};_eag :=_dg .NewScanner (_ddd );for _eag .Scan (){_eb .Println (_eag .Text ());};if _age :=_ecb .Wait ();_age !=nil {_bad ,_ :=_fac .ReadAll (_fda );_ec .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0077a\u0069\u0074\u0069\u006e\u0067\u0020o\u006e\u0020\u0078\u006d\u006c\u0069\u006ed\u0065\u006e\u0074\u003a\u0020\u0025\u0073\u0020\u005b\u0025s\u005d",string (_bad ),_age );
};};func (_bcg *ReferenceFile )Update (currentMap *ReferenceMap )error {if _bcg ._bbaa ==""{return nil ;};_bg :=_bcg .updateMap (currentMap );if _bg ==0{return nil ;};_ga ,_afd :=_ag .OpenFile (_bcg ._bbaa ,_ag .O_CREATE |_ag .O_TRUNC |_ag .O_WRONLY ,0664);
if _afd !=nil {return _afd ;};defer _ga .Close ();_bcg .Timestamp =_c .Now ().UTC ();_fcb :=_bd .NewEncoder (_ga );_fcb .SetIndent ("","\u0009");return _fcb .Encode (_bcg );};func _aace (_gddg ,_aacd string )error {_bef ,_eef :=_ag .Open (_gddg );if _eef !=nil {return _eef ;
};defer _bef .Close ();_fdc ,_ ,_eef :=_gf .DecodeConfig (_bef );if _eef !=nil {panic (_eef );};_afde :=_gf .NewRGBA (_gf .Rect (0,0,_fdc .Width ,_fdc .Height ));_bdd ,_eef :=_ag .Create (_aacd );if _eef !=nil {return _eef ;};defer _bdd .Close ();_eef =_b .Encode (_bdd ,_afde );
if _eef !=nil {return _eef ;};return nil ;};func _ccfe (_ceb ,_eaee *_f .File )func (_bdf *_fca .T ){return func (_gd *_fca .T ){_bba ,_deb :=_ceb .Open ();if _deb !=nil {_gd .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_ceb .Name );
};defer _bba .Close ();_bfb ,_deb :=_eaee .Open ();if _deb !=nil {_gd .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_eaee .Name );};defer _bfb .Close ();_dfd ,_ :=_fac .ReadAll (_bba );_ed ,_ :=_fac .ReadAll (_bfb );
if !_gff .Equal (_dfd ,_ed ){_egc (_gd ,_dfd ,_ed );_ae .Println (string (_dfd ));_ae .Println (string (_ed ));_gd .Errorf ("\u006d\u0069\u0073\u006da\u0074\u0063\u0068\u0065\u0064\u0020\u0063\u006f\u006e\u0074e\u006et\u0073\u0020\u0025\u0064\u0020\u0076\u0073 \u0025\u0064",len (_dfd ),len (_ed ));
};};};func CompareGoldenXML (t *_fca .T ,expectedFn string ,got []byte ){_ccb :=_df .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );if *_acf {if _fg :=_ag .WriteFile (_ccb ,got ,0644);_fg !=nil {t .Fatal (_fg );};};_ca ,_bf :=_ag .ReadFile (_ccb );
if _bf !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065 \u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0065\u0078\u0070\u0065\u0063t\u0065\u0064\u0020\u0069\u006e\u0070\u0075t\u003a\u0020\u0025\u0073",_bf );};_egc (t ,_ca ,got );};func (_ccfee *ReferenceFile )updateMap (_gcb *ReferenceMap )int {var _dddd int ;
if _ccfee .Map ._gdg ==nil {_ccfee .Map ._gdg =map[string ]ReferenceEntry {};};for _bfg ,_ee :=range _gcb ._gdg {_fcab ,_ecbd :=_ccfee .Map ._gdg [_bfg ];if !_ecbd {_ccfee .Map ._gdg [_bfg ]=_ee ;_dddd ++;continue ;};if string (_fcab .Value )!=string (_ee .Value ){_ccfee .Map ._gdg [_bfg ]=_ee ;
_dddd ++;};};for _gdd :=range _ccfee .Map ._gdg {if _ ,_ge :=_gcb ._gdg [_gdd ];!_ge {delete (_ccfee .Map ._gdg ,_gdd );_dddd ++;};};return _dddd ;};func CompareZip (t *_fca .T ,expectedFn string ,got []byte ,cmpFileContents bool ){_ccf :=_df .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
_ab ,_bc :=_f .NewReader (_gff .NewReader (got ),int64 (len (got )));if _bc !=nil {t .Fatalf ("\u0075\u006ea\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0074\u0065\u0073\u0074\u0020\u0069\u006e\u0070\u0075\u0074: \u0025\u0073",_bc );
};_gb ,_bc :=_ag .Open (_ccf );if _bc !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020r\u0065\u0061\u0064\u0020\u0067\u006f\u006cd\u0065\u006e\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_bc );};defer _gb .Close ();
_eae ,_bc :=_ag .Stat (_ccf );if _bc !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_bc );};_gbf ,_bc :=_f .NewReader (_gb ,_eae .Size ());if _bc !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_bc );
};t .Run (expectedFn ,_dfc (_gbf ,_ab ,cmpFileContents ));};func _beec (_gded *_gf .RGBA ,_dgdeg string ,_gbd string ,_dfga ,_efb int )error {_acd ,_dcg :=_fc .ReadFile (_dgdeg );if _dcg !=nil {return _dcg ;};_eeb ,_dcg :=_dc .Parse (_acd );if _dcg !=nil {return _dcg ;
};_ebg ,_dcg :=_dc .NewFace (_eeb ,&_dc .FaceOptions {Size :18,DPI :72,Hinting :_bb .HintingNone });if _dcg !=nil {return _dcg ;};_ebe :=&_bb .Drawer {Dst :_gded ,Src :_gf .NewUniform (_d .RGBA {200,100,0,255}),Face :_ebg ,Dot :_eac .P (_dfga ,_efb )};
_ebe .DrawString (_gbd );return nil ;};type ValidationResult struct{File string `json:"file"`;Result bool `json:"result"`;Note string `json:"note"`;};func HashFile (file string )(string ,error ){_aac ,_beg :=_ag .Open (file );if _beg !=nil {return "",_beg ;
};defer _aac .Close ();_cdg :=_ea .New ();if _ ,_beg =_fac .Copy (_cdg ,_aac );_beg !=nil {return "",_beg ;};return _ff .EncodeToString (_cdg .Sum (nil )),nil ;};func RunRenderOfficeTest (t *_fca .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ,postfix string ){_abg :=_fa .TrimSuffix (_df .Base (pdfPath ),_df .Ext (pdfPath ));
t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_bbcd *_fca .T ){_bga :=_df .Join (outputDir ,_abg );_dag :=_bga +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _aacdb :=RenderPDFToPNGs (pdfPath ,0,_dag );_aacdb !=nil {_bbcd .Skip (_aacdb );};_aabb :=_abg +postfix ;
_dcge :=_df .Join (outputDir ,_aabb );_dfdb :=_dcge +"\u002d%\u0064\u002e\u0070\u006e\u0067";_gce :=false ;if saveBaseline {_acda :=_df .Dir (pdfPath );_dcbgb :=_df .Join (_acda ,_aabb +"\u002e\u0070\u0064\u0066");if _ ,_gdfc :=_ag .Stat (_dcbgb );_gdfc ==nil {_bbcd .Logf ("\u0052e\u006e\u0064\u0065\u0072\u0020\u004d\u0053\u0020\u004f\u0066\u0066i\u0063\u0065\u0020\u0050\u0044\u0046\u003a\u0020\u0025\u0076",_dcbgb );
if _fee :=RenderPDFToPNGs (_dcbgb ,0,_dfdb );_fee !=nil {_bbcd .Skip (_fee );};_gce =true ;};};for _cff :=1;true ;_cff ++{_agc :=_ae .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_bga ,_cff );_fece :=_df .Join (baselineRenderPath ,_ae .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_abg ,_cff ));
if _ ,_caac :=_ag .Stat (_agc );_caac !=nil {break ;};_bbcd .Logf ("\u0025\u0073",_fece );if saveBaseline {_bbcd .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_agc ,_fece );_bcf :=CopyFile (_agc ,_fece );
if _bcf !=nil {_bbcd .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_fece ,_bcf );};if _gce {_eaeg :=_ae .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_dcge ,_cff );
_fgga :=_df .Join (baselineRenderPath ,_ae .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_aabb ,_cff ));_bbcd .Logf ("\u0043\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u004d\u0053\u0020\u0057\u006f\u0072\u0064 \u0072e\u0073\u0075\u006c\u0074\u0073\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_eaeg ,_fgga );
_bfec :=CopyFile (_eaeg ,_fgga );if _bfec !=nil {_bbcd .Logf ("\u0045\u0052\u0052\u004f\u0052\u0020\u0063\u006f\u0070\u0079\u0069\u006eg\u0020\u0074\u006f \u0025\u0073\u003a\u0020\u0025\u0076\u002c\u0020\u0068\u0061\u0076i\u006e\u0067\u0020d\u0069\u0066\u0066\u0065r\u0065\u006e\u0074\u0020\u0070\u0061\u0067\u0065\u0020\u0073\u0069\u007a\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u002c\u0020\u0072\u0065\u0070\u006c\u0061\u0063\u0069\u006eg\u0020\u0069\u0074\u0020\u0077\u0069\u0074\u0068\u0020\u0062\u006ca\u006e\u006b\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0069\u006e\u0073\u0074\u0065\u0061\u0064",_fgga ,_bfec );
if _cagf :=_aace (_fece ,_fgga );_cagf !=nil {_bbcd .Fatalf ("\u0045\u0052\u0052\u004f\u0052\u0020c\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0065\u006d\u0070\u0074\u0079 \u0069\u006d\u0061\u0067\u0065\u0020\u0025s\u003a\u0020\u0025\u0076",_fgga ,_cagf );
};};_bbcd .Logf ("\u0043\u006fm\u0062\u0069\u006e\u0069\u006eg\u0020\u0055\u006e\u0069\u004ff\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_fece ,_fgga );
_fcg ,_bfec :=CombinePNGFiles (_fece ,_fgga );if _ag .IsNotExist (_bfec ){_bbcd .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_fcg {_bbcd .Fatal ("\u0055n\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0063\u006f\u006db\u0069\u006e\u0065\u0020\u0069\u006d\u0061\u0067\u0065\u0073");
};_bbcd .Logf ("\u0043\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0064\u0069\u0066f \u0055n\u0069\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075l\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065 \u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_fece ,_fgga );
_fcg ,_gfc ,_bcab ,_ede ,_bfec :=CreatePNGDiff (_fece ,_fgga );if _bfec !=nil &&_cc .Is (_bfec ,ErrImageSizeNotMatch ){_bbcd .Fatalf ("\u0045\u0072\u0072\u006fr\u0020\u006f\u006e\u0020\u0063\u0072\u0065\u0061\u0074\u0065 \u0050N\u0047\u0020\u0044\u0069\u0066\u0066\u003a \u0025\u0076",_bfec );
};if _fcg {_bbcd .Logf ("\u0049\u006d\u0061\u0067\u0065\u003a\u0020\u0025\u0073\u000a",_gfc );_bbcd .Logf ("D\u0069\u0066\u0066\u0020Pe\u0072c\u0065\u006e\u0074\u003a\u0020%\u0032\u002e\u0066\u0025\u0025\u000a",_bcab );_bbcd .Logf ("\u0044i\u0066f\u0020\u0054\u006f\u0074\u0061\u006c\u003a\u0020\u0025\u0066\u000a",_ede );
_ccbe :=_df .Base (_gfc );_agf ,_gec :=currentHashMap .Read (_ccbe );if _gec &&(_agf .DiffPercent < _bcab ||_agf .DiffTotal < _ede ){_bbcd .Logf ("\u004e\u0065\u0077\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0068\u0061\u0076\u0069\u006e\u0067 h\u0069g\u0068\u0065\u0072\u0020\u0064\u0069\u0066\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0070\u0065\u0072\u0063\u0065\u006e\u0074\u003a\u0020\u0025\u0066\u0020\u0061\u006e\u0064 \u0074\u006f\u0074\u0061\u006c\u0020\u0025\u0066\u000a",_bcab ,_ede );
};_ffag ,_affd :=HashFile (_gfc );_eg .NoError (_bbcd ,_affd );_ecf :=_gae (_bbcd ,_gfc );if !_gec ||_agf .Value !=_ffag ||_agf .ResultSize !=_ecf ||_agf .DiffPercent !=_bcab ||_agf .DiffTotal !=_ede {_ceff :=ReferenceEntry {Timestamp :_c .Now ().UTC ().Unix (),Value :_ffag ,ResultSize :_ecf ,DiffPercent :_bcab ,DiffTotal :_ede };
currentHashMap .Write (_ccbe ,_ceff );if _affd =refFile .Update (currentHashMap );_affd !=nil {_bbcd .Logf ("\u0055\u0070\u0064\u0061\u0074\u0065\u0020\u0072\u0065\u0066\u0065\u0072\u0065\u006e\u0063e\u0020f\u0069\u006c\u0065\u0020\u0066\u0061\u0069\u006c\u0065\u0064\u003a\u0020\u0025\u0076",_affd );
};};};};continue ;};_bbcd .Run (_ae .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_cff ),func (_fde *_fca .T ){_fde .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_agc ,_fece );_agd ,_cbd :=ComparePNGFiles (_agc ,_fece );
if _ag .IsNotExist (_cbd ){_fde .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_agd {_fde .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func _cca (_cag string )string {_cebd ,_ :=_ag .CreateTemp ("",_cag );defer _cebd .Close ();return _cebd .Name ();};func _ef (_aee string )error {_aa :=_de .XSDAny {};_caa ,_bag :=_ag .Open (_aee );if _bag !=nil {return _bag ;};_caf :=_ac .NewDecoder (_caa );
if _bag =_caf .Decode (&_aa );_bag !=nil {return _bag ;};_caa .Close ();_caa ,_bag =_ag .Create (_aee );if _bag !=nil {return _bag ;};defer _caa .Close ();_fd :=_ac .NewEncoder (_caa );_fd .Indent ("","\u0020\u0020");return _fd .Encode (&_aa );};func ReadPNG (file string )(_gf .Image ,error ){_ecd ,_da :=_ag .Open (file );
if _da !=nil {return nil ,_da ;};defer _ecd .Close ();return _b .Decode (_ecd );};func _dfc (_adb ,_aba *_f .Reader ,_cd bool )func (_bbb *_fca .T ){return func (_fge *_fca .T ){_ebf :=make ([]*_f .File ,len (_adb .File ));copy (_ebf ,_adb .File );_cdc :=make ([]*_f .File ,len (_aba .File ));
copy (_cdc ,_aba .File );if len (_ebf )!=len (_cdc ){_fge .Errorf ("\u0065x\u0070\u0065\u0063\u0074e\u0064\u0020\u0025\u0064\u0020f\u0069l\u0065s\u002c\u0020\u0067\u006f\u0074\u0020\u0025d",len (_adb .File ),len (_aba .File ));};for _add ,_ebd :=range _ebf {for _ffd ,_gcf :=range _cdc {if _gcf ==nil {continue ;
};if _ebd .Name ==_gcf .Name {if _cd {_fge .Run (_ebd .Name ,_ccfe (_ebd ,_gcf ));};_ebf [_add ]=nil ;_cdc [_ffd ]=nil ;};};};for _ ,_ccgd :=range _ebf {if _ccgd !=nil {_fge .Errorf ("\u0064\u0069\u0064\u006e\u0027\u0074\u0020\u0066\u0069\u006ed\u0020\u0065\u0078\u0070\u0065\u0063\u0074e\u0064\u0020\u0066\u0069\u006c\u0065\u0020\u0027\u0025\u0073\u0027",_ccgd .Name );
};};for _ ,_cb :=range _cdc {if _cb !=nil {_fge .Errorf ("\u0066\u006f\u0075\u006e\u0064\u0020\u0075\u006e\u0065\u0078\u0070e\u0063\u0074\u0065\u0064\u0020\u0066\u0069\u006c\u0065\u0020'\u0025\u0073\u0027",_cb .Name );};};};};func (_bff *ReferenceMap )Write (key string ,entry ReferenceEntry ){_bff .Lock ();
defer _bff .Unlock ();if _bff ._gdg ==nil {_bff ._gdg =map[string ]ReferenceEntry {};};_bff ._gdg [key ]=entry ;};func CompareGoldenZipFilesOnly (t *_fca .T ,expectedFn string ,got []byte ){_af :=_df .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
if *_acf {if _gc :=_ag .WriteFile (_af ,got ,0644);_gc !=nil {t .Fatal (_gc );};};CompareZip (t ,expectedFn ,got ,false );};func _bbc (_bee ,_cbg _gf .Rectangle )bool {return _bee .Min .X ==_cbg .Min .X &&_bee .Min .Y ==_cbg .Min .Y &&_bee .Max .X ==_cbg .Max .X &&_bee .Max .Y ==_cbg .Max .Y ;
};func (_ffe *ReferenceMap )Copy ()*ReferenceMap {_cab :=ReferenceMap {_gdg :make (map[string ]ReferenceEntry ,len (_ffe ._gdg ))};for _db ,_ega :=range _ffe ._gdg {_cab ._gdg [_db ]=_ega ;};return &_cab ;};func CopyFile (src ,dst string )error {_cfge ,_cfa :=_ag .Open (src );
if _cfa !=nil {return _cfa ;};defer _cfge .Close ();_dfca ,_cfa :=_ag .Create (dst );if _cfa !=nil {return _cfa ;};defer _dfca .Close ();_ ,_cfa =_fac .Copy (_dfca ,_cfge );return _cfa ;};var _acf =_adg .Bool ("t\u0065\u0073\u0074\u002e\u0075\u0070\u0064\u0061\u0074\u0065",false ,"\u0075p\u0064a\u0074\u0065\u0020\u0067\u006fl\u0064\u0065n\u0020\u0066\u0069\u006c\u0065");
func CompareImages (img1 ,img2 _gf .Image )(bool ,error ){_acb :=img1 .Bounds ();_bde :=0;for _ace :=0;_ace < _acb .Size ().X ;_ace ++{for _ggc :=0;_ggc < _acb .Size ().Y ;_ggc ++{_cebdf ,_eca ,_debd ,_ :=img1 .At (_ace ,_ggc ).RGBA ();_ffae ,_aga ,_aea ,_ :=img2 .At (_ace ,_ggc ).RGBA ();
if _cebdf !=_ffae ||_eca !=_aga ||_debd !=_aea {_bde ++;};};};_cdfg :=float64 (_bde )/float64 (_acb .Dx ()*_acb .Dy ());if _cdfg > 0.0001{_ae .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_cdfg ,_bde );
return false ,nil ;};return true ,nil ;};func ReadFile (dirPath ,testName string ,createEmpty bool )(*ReferenceFile ,error ){if dirPath ==""&&createEmpty {return &ReferenceFile {Map :&ReferenceMap {}},nil ;};if dirPath ==""{return nil ,_ag .ErrNotExist ;
};_eba :=_df .Join (dirPath ,testName +"\u005fr\u0065f\u0065\u0072\u0065\u006e\u0063\u0065\u002e\u006a\u0073\u006f\u006e");_gbe :=&ReferenceFile {_bbaa :_eba };_ege ,_cfg :=_ag .Open (_eba );if _cc .Is (_cfg ,_ag .ErrNotExist )&&createEmpty {_gbe .Timestamp =_c .Now ().UTC ();
_gbe .Map =&ReferenceMap {};return _gbe ,nil ;};if _cfg !=nil {return nil ,_cfg ;};defer _ege .Close ();if _fe :=_bd .NewDecoder (_ege ).Decode (_gbe );_fe !=nil {if _fe .Error ()=="i\u006c\u006c\u0065\u0067\u0061\u006c \u0062\u0061\u0073\u0065\u0036\u0034 \u0064\u0061\u0074\u0061\u0020\u0061\u0074 \u0069\u006e\u0070\u0075\u0074\u0020\u0062\u0079\u0074\u0065 \u0030"&&createEmpty {return _gbe ,nil ;
};return nil ,_fe ;};return _gbe ,nil ;};func (_egg *ReferenceMap )Read (key string )(ReferenceEntry ,bool ){_egg .Lock ();defer _egg .Unlock ();if _egg ._gdg ==nil {return ReferenceEntry {},false ;};_aaa ,_eaa :=_egg ._gdg [key ];return _aaa ,_eaa ;};
func (_ead *ReferenceMap )Keys ()(_gba []string ){_gba =make ([]string ,len (_ead ._gdg ));var _ded int ;for _bfe :=range _ead ._gdg {_gba [_ded ]=_bfe ;_ded ++;};return _gba ;};type ReferenceEntry struct{Timestamp int64 `json:"timestamp"`;Value string `json:"value"`;
ResultSize int64 `json:"resultSize,omitempty"`;DiffPercent float64 `json:"diffPercent,omitempty"`;DiffTotal float64 `json:"diffValue,omitempty"`;Invalid bool `json:"markedInvalid,omitempty"`;};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;
};if _ ,_dda :=_be .LookPath ("\u0067\u0073");_dda !=nil {return ErrRenderNotSupported ;};return _be .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_ae .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};func CompareGoldenZip (t *_fca .T ,expectedFn string ,got []byte ){_ce :=_df .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );if *_acf {if _bdg :=_ag .WriteFile (_ce ,got ,0644);_bdg !=nil {t .Fatal (_bdg );};};CompareZip (t ,expectedFn ,got ,true );
};func (_ebfa *ReferenceMap )MarshalJSON ()([]byte ,error ){return _bd .Marshal (_ebfa ._gdg )};func ValidateDocument (file string )(bool ,error ){var (_adbe string =_ag .Getenv ("\u0050\u0052\u004fJ\u0045\u0043\u0054\u005f\u0052\u004f\u004f\u0054");_dbfe string =_ag .Getenv ("\u0048\u004f\u004d\u0045")+"\u002f\u0064\u006f\u0074\u006e\u0065\u0074\u002f\u0064o\u0074\u006e\u0065\u0074";
_adbd string =_adbe +"\u002f\u002e\u0063\u0069\u002f\u006f\u0070\u0065\u006e\u0078\u006dl\u002d\u0076\u0061\u006c\u0069\u0064\u0061\u0074o\u0072/\u0062\u0069\u006e\u002f\u0052\u0065\u006c\u0065\u0061\u0073\u0065\u002f\u006e\u0065\u0074\u0038\u002e\u0030/\u0050\u0072\u006f\u0067\u0072\u0061\u006d\u002e\u0064\u006c\u006c";
_bae string =_adbe +"\u002f\u0069\u006et\u0065\u0072\u006e\u0061\u006c\u002f\u0074\u0065\u0073\u0074\u0075\u0074\u0069\u006c\u0073\u002f\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e\u005f\u0072\u0065s\u0075\u006c\u0074\u002e\u006a\u0073\u006f\u006e";
_bcc _gff .Buffer ;_gbfb string ;_bbf bool =true ;);if _ ,_gbg :=_ag .Stat (_dbfe );_gbg !=nil {_ba .Log .Debug ("\u0064\u006f\u0074\u006e\u0065\u0074 \u0065\u0078\u0065\u0063\u0075\u0074\u0061\u0062\u006c\u0065\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_dbfe );
return true ,nil ;};if _ ,_gbeg :=_ag .Stat (_adbd );_gbeg !=nil {_ba .Log .Debug ("\u006f\u0070\u0065\u006e\u0078\u006dl\u002d\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u006f\u0072\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_adbd );
return true ,nil ;};var (_ggcf map[string ]map[string ]*ValidationResult ;_bbg *ValidationResult ;);_bab ,_gdb :=_ag .ReadFile (_bae );if _gdb !=nil {return false ,_gdb ;};if _dab :=_bd .Unmarshal (_bab ,&_ggcf );_dab !=nil {return false ,_dab ;};if _ggcf ==nil {_ggcf =make (map[string ]map[string ]*ValidationResult );
};_fef :=_df .Ext (file );_fef =_fef [1:];if _fef !="\u0064\u006f\u0063\u0078"&&_fef !="\u0078\u006c\u0073\u0078"&&_fef !="\u0070\u0070\u0074\u0078"{return false ,_ae .Errorf ("\u0075\u006e\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065d\u0020\u0066\u0069\u006c\u0065\u0020\u0065x\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u003a\u0020\u0025\u0073",_fef );
};_dcba :=_df .Base (file );if _fb ,_cba :=_ggcf [_fef ];_cba {if _ffba ,_cbge :=_fb [_dcba ];_cbge {_bbg =_ffba ;};};_bea :=_be .Command (_dbfe ,_adbd ,"\u002d\u002d"+_fef ,file );_bea .Stderr =&_bcc ;_degd ,_gdb :=_bea .Output ();if _gdb !=nil {_gbfb =_bcc .String ();
};_dbg :=string (_degd );_dbg =_fa .TrimSpace (_dbg [_fa .Index (_dbg ,"\u000a")+1:]);if _fa .Contains (_dbg ,"\u0045x\u0063\u0065\u0070\u0074\u0069\u006fn")||_fa .Contains (_dbg ,"\u0069\u0073\u0020n\u006f\u0074\u0020\u0076\u0061\u006c\u0069\u0064"){_bbf =false ;
if _fa .Contains (_dbg ,"\u006da\u0069\u006e\u003a\u0073\u007a")||_fa .Contains (_dbg ,"m\u0061\u0069\u006e\u003a\u0066\u0061\u006d\u0069\u006c\u0079")||_fa .Contains (_dbg ,"\u0063h\u0061\u0072\u0074\u003a\u0065\u0078t"){_gbfb ="\u0046\u0061\u0069\u006c\u0065\u0064\u0020\u0076\u0061\u006ci\u0064\u0061\u0074\u0069\u006f\u006e\u0020i\u0073\u0020\u0069\u0067\u006e\u006f\u0072\u0065\u0064\u003a\u0020"+_dbg ;
_bbf =true ;};};if _gbfb ==""{_gbfb =_dbg ;};if _bbg ==nil {_bbg =&ValidationResult {File :_dcba ,Result :_bbf ,Note :_gbfb };};_bbg .Result =_bbf ;_bbg .Note =_gbfb ;if _ggcf [_fef ]==nil {_ggcf [_fef ]=make (map[string ]*ValidationResult );};if _fgb ,_acdd :=_ggcf [_fef ][_dcba ];
_acdd {if _fgb .Result &&!_bbf {return false ,_ae .Errorf ("V\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e \u0072\u0065\u0073\u0075\u006c\u0074\u0020ch\u0061\u006e\u0067\u0065d\u0020\u0066\u006f\u0072\u0020\u0025\u0073\u003a\u0020%v\u0020\u002d>\u0020\u0025\u0076\u0020\u0028\u0025\u0073\u0029",file ,_fgb .Result ,_bbf ,_gbfb );
};};_ggcf [_fef ][_dcba ]=_bbg ;_bab ,_gdb =_bd .MarshalIndent (_ggcf ,"","\u0020\u0020");if _gdb !=nil {return false ,_gdb ;};if _afb :=_ag .WriteFile (_bae ,_bab ,0644);_afb !=nil {return false ,_afb ;};return true ,nil ;};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_cef ,_bca :=HashFile (file1 );
if _bca !=nil {return false ,_bca ;};_bagg ,_bca :=HashFile (file2 );if _bca !=nil {return false ,_bca ;};if _cef ==_bagg {return true ,nil ;};_cfgd ,_bca :=ReadPNG (file1 );if _bca !=nil {return false ,_bca ;};_faa ,_bca :=ReadPNG (file2 );if _bca !=nil {return false ,_bca ;
};if _cfgd .Bounds ()!=_faa .Bounds (){return false ,nil ;};return CompareImages (_cfgd ,_faa );};type ReferenceMap struct{_ad .Mutex ;_gdg map[string ]ReferenceEntry ;};func CombinePNGFiles (file1 ,file2 string )(bool ,error ){_aec ,_gaa :=ReadPNG (file1 );
if _gaa !=nil {return false ,_gaa ;};_cfb ,_gaa :=ReadPNG (file2 );if _gaa !=nil {return false ,_gaa ;};_ccd :=_gf .Point {_aec .Bounds ().Dx (),0};_fgg :=_gf .Rectangle {_ccd ,_ccd .Add (_cfb .Bounds ().Size ())};_ccbf :=_gf .Rectangle {_gf .Point {0,0},_fgg .Max };
_cdca :=_gf .NewRGBA (_ccbf );_e .Draw (_cdca ,_aec .Bounds (),_aec ,_gf .Point {0,0},_e .Src );_e .Draw (_cdca ,_fgg ,_cfb ,_gf .Point {0,0},_e .Src );_agg :=_df .Dir (file1 );_gde :=_fa .TrimSuffix (_df .Base (file1 ),_df .Ext (file1 ));_deg ,_gaa :=_ag .Create (_agg +"\u002f"+_gde +"\u002d\u0063\u006f\u006d\u0062\u0069\u006e\u0065\u0064\u002e\u0070\u006e\u0067");
if _gaa !=nil {return false ,_gaa ;};defer _deg .Close ();if _cfe :=_b .Encode (_deg ,_cdca );_cfe !=nil {return false ,_cfe ;};return true ,nil ;};