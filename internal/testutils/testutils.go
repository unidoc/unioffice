//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_a "archive/zip";_ef "bufio";_gg "bytes";_cf "crypto/md5";_ba "encoding/hex";_da "encoding/json";_fe "encoding/xml";_g "errors";_db "flag";_deb "fmt";_cb "github.com/stretchr/testify/require";_dfe "github.com/unidoc/unioffice/v2";
_ed "github.com/unidoc/unipdf/v4/common";_cd "golang.org/x/image/font";_fdf "golang.org/x/image/font/opentype";_ccc "golang.org/x/image/math/fixed";_df "image";_ag "image/color";_e "image/draw";_ad "image/png";_be "io";_ce "io/ioutil";_de "log";_dc "math";
_gd "os";_fd "os/exec";_cc "path/filepath";_d "strings";_f "sync";_b "testing";_aa "time";);func (_bd *ReferenceFile )Update (currentMap *ReferenceMap )error {if _bd ._bb ==""{return nil ;};_edc :=_bd .updateMap (currentMap );if _edc ==0{return nil ;};
_ddab ,_eed :=_gd .OpenFile (_bd ._bb ,_gd .O_CREATE |_gd .O_TRUNC |_gd .O_WRONLY ,0664);if _eed !=nil {return _eed ;};defer _ddab .Close ();_bd .Timestamp =_aa .Now ().UTC ();_dab :=_da .NewEncoder (_ddab );_dab .SetIndent ("","\u0009");return _dab .Encode (_bd );
};func _ga (_beb ,_acf *_a .Reader ,_dcc bool )func (_ae *_b .T ){return func (_ecc *_b .T ){_cg :=make ([]*_a .File ,len (_beb .File ));copy (_cg ,_beb .File );_ff :=make ([]*_a .File ,len (_acf .File ));copy (_ff ,_acf .File );if len (_cg )!=len (_ff ){_ecc .Errorf ("\u0065x\u0070\u0065\u0063\u0074e\u0064\u0020\u0025\u0064\u0020f\u0069l\u0065s\u002c\u0020\u0067\u006f\u0074\u0020\u0025d",len (_beb .File ),len (_acf .File ));
};for _cbd ,_aae :=range _cg {for _fa ,_cgd :=range _ff {if _cgd ==nil {continue ;};if _aae .Name ==_cgd .Name {if _dcc {_ecc .Run (_aae .Name ,_dcb (_aae ,_cgd ));};_cg [_cbd ]=nil ;_ff [_fa ]=nil ;};};};for _ ,_ecf :=range _cg {if _ecf !=nil {_ecc .Errorf ("\u0064\u0069\u0064\u006e\u0027\u0074\u0020\u0066\u0069\u006ed\u0020\u0065\u0078\u0070\u0065\u0063\u0074e\u0064\u0020\u0066\u0069\u006c\u0065\u0020\u0027\u0025\u0073\u0027",_ecf .Name );
};};for _ ,_cab :=range _ff {if _cab !=nil {_ecc .Errorf ("\u0066\u006f\u0075\u006e\u0064\u0020\u0075\u006e\u0065\u0078\u0070e\u0063\u0074\u0065\u0064\u0020\u0066\u0069\u006c\u0065\u0020'\u0025\u0073\u0027",_cab .Name );};};};};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_fc ,_cba :=HashFile (file1 );
if _cba !=nil {return false ,_cba ;};_bbc ,_cba :=HashFile (file2 );if _cba !=nil {return false ,_cba ;};if _fc ==_bbc {return true ,nil ;};_abf ,_cba :=ReadPNG (file1 );if _cba !=nil {return false ,_cba ;};_aac ,_cba :=ReadPNG (file2 );if _cba !=nil {return false ,_cba ;
};if _abf .Bounds ()!=_aac .Bounds (){return false ,nil ;};return CompareImages (_abf ,_aac );};func _dcb (_fg ,_eda *_a .File )func (_gf *_b .T ){return func (_cdd *_b .T ){_fb ,_eg :=_fg .Open ();if _eg !=nil {_cdd .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_fg .Name );
};defer _fb .Close ();_afd ,_eg :=_eda .Open ();if _eg !=nil {_cdd .Errorf ("\u0065\u0072r\u006f\u0072\u0020o\u0070\u0065\u006e\u0069\u006e\u0067\u0020\u0025\u0073",_eda .Name );};defer _afd .Close ();_bg ,_ :=_be .ReadAll (_fb );_eb ,_ :=_be .ReadAll (_afd );
if !_gg .Equal (_bg ,_eb ){_gfd (_cdd ,_bg ,_eb );_deb .Println (string (_bg ));_deb .Println (string (_eb ));_cdd .Errorf ("\u006d\u0069\u0073\u006da\u0074\u0063\u0068\u0065\u0064\u0020\u0063\u006f\u006e\u0074e\u006et\u0073\u0020\u0025\u0064\u0020\u0076\u0073 \u0025\u0064",len (_bg ),len (_eb ));
};};};func (_ace *ReferenceMap )Read (key string )(ReferenceEntry ,bool ){_ace .Lock ();defer _ace .Unlock ();if _ace ._bgf ==nil {return ReferenceEntry {},false ;};_egg ,_cac :=_ace ._bgf [key ];return _egg ,_cac ;};func CompareGoldenZipFilesOnly (t *_b .T ,expectedFn string ,got []byte ){_dg :=_cc .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
if *_ac {if _ec :=_gd .WriteFile (_dg ,got ,0644);_ec !=nil {t .Fatal (_ec );};};CompareZip (t ,expectedFn ,got ,false );};func _ffc (_agbd ,_bda _df .Rectangle )bool {return _agbd .Min .X ==_bda .Min .X &&_agbd .Min .Y ==_bda .Min .Y &&_agbd .Max .X ==_bda .Max .X &&_agbd .Max .Y ==_bda .Max .Y ;
};func (_faf *ReferenceFile )updateMap (_deg *ReferenceMap )int {var _add int ;if _faf .Map ._bgf ==nil {_faf .Map ._bgf =map[string ]ReferenceEntry {};};for _dfg ,_feb :=range _deg ._bgf {_fgc ,_bag :=_faf .Map ._bgf [_dfg ];if !_bag {_faf .Map ._bgf [_dfg ]=_feb ;
_add ++;continue ;};if string (_fgc .Value )!=string (_feb .Value ){_faf .Map ._bgf [_dfg ]=_feb ;_add ++;};};for _abd :=range _faf .Map ._bgf {if _ ,_egd :=_deg ._bgf [_abd ];!_egd {delete (_faf .Map ._bgf ,_abd );_add ++;};};return _add ;};var _ac =_db .Bool ("t\u0065\u0073\u0074\u002e\u0075\u0070\u0064\u0061\u0074\u0065",false ,"\u0075p\u0064a\u0074\u0065\u0020\u0067\u006fl\u0064\u0065n\u0020\u0066\u0069\u006c\u0065");
func HashFile (file string )(string ,error ){_eea ,_fac :=_gd .Open (file );if _fac !=nil {return "",_fac ;};defer _eea .Close ();_gef :=_cf .New ();if _ ,_fac =_be .Copy (_gef ,_eea );_fac !=nil {return "",_fac ;};return _ba .EncodeToString (_gef .Sum (nil )),nil ;
};func CombinePNGFiles (file1 ,file2 string )(bool ,error ){_faag ,_egb :=ReadPNG (file1 );if _egb !=nil {return false ,_egb ;};_bgb ,_egb :=ReadPNG (file2 );if _egb !=nil {return false ,_egb ;};_fdc :=_df .Point {_faag .Bounds ().Dx (),0};_dgb :=_df .Rectangle {_fdc ,_fdc .Add (_bgb .Bounds ().Size ())};
_eee :=_df .Rectangle {_df .Point {0,0},_dgb .Max };_feg :=_df .NewRGBA (_eee );_e .Draw (_feg ,_faag .Bounds (),_faag ,_df .Point {0,0},_e .Src );_e .Draw (_feg ,_dgb ,_bgb ,_df .Point {0,0},_e .Src );_adc :=_cc .Dir (file1 );_ddg :=_d .TrimSuffix (_cc .Base (file1 ),_cc .Ext (file1 ));
_eca ,_egb :=_gd .Create (_adc +"\u002f"+_ddg +"\u002d\u0063\u006f\u006d\u0062\u0069\u006e\u0065\u0064\u002e\u0070\u006e\u0067");if _egb !=nil {return false ,_egb ;};defer _eca .Close ();if _cfb :=_ad .Encode (_eca ,_feg );_cfb !=nil {return false ,_cfb ;
};return true ,nil ;};var (ErrRenderNotSupported =_g .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
ErrImageSizeNotMatch =_g .New ("\u0069\u006d\u0061ge\u0020\u0073\u0069\u007a\u0065\u0073\u0020\u0064\u006f\u006e\u0027\u0074\u0020\u006d\u0061\u0074\u0063\u0068"););func _gbf (_dde ,_aee string )error {_afe ,_cdea :=_gd .Open (_dde );if _cdea !=nil {return _cdea ;
};defer _afe .Close ();_eedd ,_ ,_cdea :=_df .DecodeConfig (_afe );if _cdea !=nil {panic (_cdea );};_ege :=_df .NewRGBA (_df .Rect (0,0,_eedd .Width ,_eedd .Height ));_bef ,_cdea :=_gd .Create (_aee );if _cdea !=nil {return _cdea ;};defer _bef .Close ();
_cdea =_ad .Encode (_bef ,_ege );if _cdea !=nil {return _cdea ;};return nil ;};func CopyFile (src ,dst string )error {_gbe ,_dbf :=_gd .Open (src );if _dbf !=nil {return _dbf ;};defer _gbe .Close ();_bc ,_dbf :=_gd .Create (dst );if _dbf !=nil {return _dbf ;
};defer _bc .Close ();_ ,_dbf =_be .Copy (_bc ,_gbe );return _dbf ;};type ReferenceMap struct{_f .Mutex ;_bgf map[string ]ReferenceEntry ;};func CompareGoldenXML (t *_b .T ,expectedFn string ,got []byte ){_efe :=_cc .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
if *_ac {if _ca :=_gd .WriteFile (_efe ,got ,0644);_ca !=nil {t .Fatal (_ca );};};_dbd ,_ea :=_gd .ReadFile (_efe );if _ea !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065 \u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0065\u0078\u0070\u0065\u0063t\u0065\u0064\u0020\u0069\u006e\u0070\u0075t\u003a\u0020\u0025\u0073",_ea );
};_gfd (t ,_dbd ,got );};func (_dad *ReferenceMap )MarshalJSON ()([]byte ,error ){return _da .Marshal (_dad ._bgf )};func _gag (_dbg string )string {_cbga ,_ :=_gd .CreateTemp ("",_dbg );defer _cbga .Close ();return _cbga .Name ();};type ReferenceEntry struct{Timestamp int64 `json:"timestamp"`;
Value string `json:"value"`;ResultSize int64 `json:"resultSize,omitempty"`;DiffPercent float64 `json:"diffPercent,omitempty"`;DiffTotal float64 `json:"diffValue,omitempty"`;Invalid bool `json:"markedInvalid,omitempty"`;};func CompareZip (t *_b .T ,expectedFn string ,got []byte ,cmpFileContents bool ){_adf :=_cc .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
_dag ,_dd :=_a .NewReader (_gg .NewReader (got ),int64 (len (got )));if _dd !=nil {t .Fatalf ("\u0075\u006ea\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0074\u0065\u0073\u0074\u0020\u0069\u006e\u0070\u0075\u0074: \u0025\u0073",_dd );
};_aad ,_dd :=_gd .Open (_adf );if _dd !=nil {t .Fatalf ("\u0075\u006e\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020r\u0065\u0061\u0064\u0020\u0067\u006f\u006cd\u0065\u006e\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_dd );};defer _aad .Close ();
_cbg ,_dd :=_gd .Stat (_adf );if _dd !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_dd );};_ab ,_dd :=_a .NewReader (_aad ,_cbg .Size ());if _dd !=nil {t .Errorf ("\u0075\u006e\u0061bl\u0065\u0020\u0074\u006f\u0020\u0072\u0065\u0061\u0064\u0020\u0066\u0069\u006c\u0065\u003a\u0020\u0025\u0073",_dd );
};t .Run (expectedFn ,_ga (_ab ,_dag ,cmpFileContents ));};func _aadb (_fff ,_faae _ag .Color )bool {_ggfb ,_dae ,_gagf ,_adae :=_fff .RGBA ();_dfcc ,_bac ,_adcf ,_bfb :=_faae .RGBA ();return _ggfb ==_dfcc &&_dae ==_bac &&_gagf ==_adcf &&_adae ==_bfb ;
};func _gfd (_bgc *_b .T ,_cabg ,_dcf []byte ){_cdb :=_gag ("\u0065\u0078\u0070\u0065\u0063\u0074\u0065\u0064");_gd .WriteFile (_cdb ,_cabg ,0644);_ddd :=_gag ("\u0067\u006f\u0074");_gd .WriteFile (_ddd ,_dcf ,0644);defer func (){_gd .Remove (_cdb );_gd .Remove (_ddd )}();
_eef (_cdb );_eef (_ddd );_ada :=_fd .Command ("\u0064\u0069\u0066\u0066","\u002d\u0075",_cdb ,_ddd );_ece ,_dddc :=_ada .StdoutPipe ();if _dddc !=nil {_bgc .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_dddc );
};defer _ece .Close ();_ge ,_dddc :=_ada .StderrPipe ();if _dddc !=nil {_bgc .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0072u\u006e\u006e\u0069\u006e\u0067\u0020\u0078\u006d\u006ci\u006e\u0064\u0065n\u0074:\u0020\u0025\u0073",_dddc );};defer _ge .Close ();
if _fdg :=_ada .Start ();_fdg !=nil {_bgc .Fatalf ("\u0065\u0072\u0072\u006f\u0072\u0020\u0073\u0074\u0072\u0069\u006eg\u0020\u0078\u006d\u006c\u0069\u006e\u0064\u0065\u006e\u0074:\u0020\u0025\u0073",_fdg );};_aaeb :=_ef .NewScanner (_ece );for _aaeb .Scan (){_de .Println (_aaeb .Text ());
};if _edf :=_ada .Wait ();_edf !=nil {_agb ,_ :=_be .ReadAll (_ge );_bgc .Fatalf ("e\u0072\u0072\u006f\u0072\u0020\u0077a\u0069\u0074\u0069\u006e\u0067\u0020o\u006e\u0020\u0078\u006d\u006c\u0069\u006ed\u0065\u006e\u0074\u003a\u0020\u0025\u0073\u0020\u005b\u0025s\u005d",string (_agb ),_edf );
};};func (_dgf *ReferenceMap )Keys ()(_adfa []string ){_adfa =make ([]string ,len (_dgf ._bgf ));var _edad int ;for _ecd :=range _dgf ._bgf {_adfa [_edad ]=_ecd ;_edad ++;};return _adfa ;};func ValidateDocument (file string )(bool ,error ){var (_edfd string =_gd .Getenv ("\u0050\u0052\u004fJ\u0045\u0043\u0054\u005f\u0052\u004f\u004f\u0054");
_gcf string =_gd .Getenv ("\u0048\u004f\u004d\u0045")+"\u002f\u0064\u006f\u0074\u006e\u0065\u0074\u002f\u0064o\u0074\u006e\u0065\u0074";_dadd string =_edfd +"\u002f\u002e\u0063\u0069\u002f\u006f\u0070\u0065\u006e\u0078\u006dl\u002d\u0076\u0061\u006c\u0069\u0064\u0061\u0074o\u0072/\u0062\u0069\u006e\u002f\u0052\u0065\u006c\u0065\u0061\u0073\u0065\u002f\u006e\u0065\u0074\u0038\u002e\u0030/\u0050\u0072\u006f\u0067\u0072\u0061\u006d\u002e\u0064\u006c\u006c";
_egdb string =_edfd +"\u002f\u0069\u006et\u0065\u0072\u006e\u0061\u006c\u002f\u0074\u0065\u0073\u0074\u0075\u0074\u0069\u006c\u0073\u002f\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e\u005f\u0072\u0065s\u0075\u006c\u0074\u002e\u006a\u0073\u006f\u006e";
_acb _gg .Buffer ;_aadf string ;_abfa bool =true ;);if _ ,_eage :=_gd .Stat (_gcf );_eage !=nil {_ed .Log .Debug ("\u0064\u006f\u0074\u006e\u0065\u0074 \u0065\u0078\u0065\u0063\u0075\u0074\u0061\u0062\u006c\u0065\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_gcf );
return true ,nil ;};if _ ,_fegc :=_gd .Stat (_dadd );_fegc !=nil {_ed .Log .Debug ("\u006f\u0070\u0065\u006e\u0078\u006dl\u002d\u0076\u0061\u006c\u0069\u0064\u0061\u0074\u006f\u0072\u0020\u006e\u006ft\u0020\u0066\u006f\u0075\u006e\u0064\u0020i\u006e\u0020\u0025\u0073",_dadd );
return true ,nil ;};var (_ccf map[string ]map[string ]*ValidationResult ;_ddbc *ValidationResult ;);_bgcg ,_egbe :=_gd .ReadFile (_egdb );if _egbe !=nil {return false ,_egbe ;};if _ccd :=_da .Unmarshal (_bgcg ,&_ccf );_ccd !=nil {return false ,_ccd ;};
if _ccf ==nil {_ccf =make (map[string ]map[string ]*ValidationResult );};_bgee :=_cc .Ext (file );_bgee =_bgee [1:];if _bgee !="\u0064\u006f\u0063\u0078"&&_bgee !="\u0078\u006c\u0073\u0078"&&_bgee !="\u0070\u0070\u0074\u0078"{return false ,_deb .Errorf ("\u0075\u006e\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065d\u0020\u0066\u0069\u006c\u0065\u0020\u0065x\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u003a\u0020\u0025\u0073",_bgee );
};_cca :=_cc .Base (file );if _ddga ,_ced :=_ccf [_bgee ];_ced {if _gdca ,_bdab :=_ddga [_cca ];_bdab {_ddbc =_gdca ;};};_gec :=_fd .Command (_gcf ,_dadd ,"\u002d\u002d"+_bgee ,file );_gec .Stderr =&_acb ;_gaab ,_egbe :=_gec .Output ();if _egbe !=nil {_aadf =_acb .String ();
};_fge :=string (_gaab );_fge =_d .TrimSpace (_fge [_d .Index (_fge ,"\u000a")+1:]);if _d .Contains (_fge ,"\u0045x\u0063\u0065\u0070\u0074\u0069\u006fn")||_d .Contains (_fge ,"\u0069\u0073\u0020n\u006f\u0074\u0020\u0076\u0061\u006c\u0069\u0064"){_abfa =false ;
if _d .Contains (_fge ,"\u006da\u0069\u006e\u003a\u0073\u007a")||_d .Contains (_fge ,"m\u0061\u0069\u006e\u003a\u0066\u0061\u006d\u0069\u006c\u0079")||_d .Contains (_fge ,"\u0063h\u0061\u0072\u0074\u003a\u0065\u0078t"){_aadf ="\u0046\u0061\u0069\u006c\u0065\u0064\u0020\u0076\u0061\u006ci\u0064\u0061\u0074\u0069\u006f\u006e\u0020i\u0073\u0020\u0069\u0067\u006e\u006f\u0072\u0065\u0064\u003a\u0020"+_fge ;
_abfa =true ;};};if _aadf ==""{_aadf =_fge ;};if _ddbc ==nil {_ddbc =&ValidationResult {File :_cca ,Result :_abfa ,Note :_aadf };};_ddbc .Result =_abfa ;_ddbc .Note =_aadf ;if _ccf [_bgee ]==nil {_ccf [_bgee ]=make (map[string ]*ValidationResult );};if _adac ,_dce :=_ccf [_bgee ][_cca ];
_dce {if _adac .Result &&!_abfa {return false ,_deb .Errorf ("V\u0061\u006c\u0069\u0064\u0061\u0074\u0069\u006f\u006e \u0072\u0065\u0073\u0075\u006c\u0074\u0020ch\u0061\u006e\u0067\u0065d\u0020\u0066\u006f\u0072\u0020\u0025\u0073\u003a\u0020%v\u0020\u002d>\u0020\u0025\u0076\u0020\u0028\u0025\u0073\u0029",file ,_adac .Result ,_abfa ,_aadf );
};};_ccf [_bgee ][_cca ]=_ddbc ;_bgcg ,_egbe =_da .MarshalIndent (_ccf ,"","\u0020\u0020");if _egbe !=nil {return false ,_egbe ;};if _aag :=_gd .WriteFile (_egdb ,_bgcg ,0644);_aag !=nil {return false ,_aag ;};return true ,nil ;};func (_efc *ReferenceMap )Write (key string ,entry ReferenceEntry ){_efc .Lock ();
defer _efc .Unlock ();if _efc ._bgf ==nil {_efc ._bgf =map[string ]ReferenceEntry {};};_efc ._bgf [key ]=entry ;};func CompareImages (img1 ,img2 _df .Image )(bool ,error ){_dfc :=img1 .Bounds ();_aada :=0;for _gaa :=0;_gaa < _dfc .Size ().X ;_gaa ++{for _gbc :=0;
_gbc < _dfc .Size ().Y ;_gbc ++{_cfe ,_baa ,_fde ,_ :=img1 .At (_gaa ,_gbc ).RGBA ();_aeb ,_dbb ,_ade ,_ :=img2 .At (_gaa ,_gbc ).RGBA ();if _cfe !=_aeb ||_baa !=_dbb ||_fde !=_ade {_aada ++;};};};_fab :=float64 (_aada )/float64 (_dfc .Dx ()*_dfc .Dy ());
if _fab > 0.0001{_deb .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_fab ,_aada );return false ,nil ;};return true ,nil ;};func (_fbc *ReferenceMap )Len ()int {return len (_fbc ._bgf )};
func CreatePNGDiff (src ,dst string )(bool ,string ,float64 ,float64 ,error ){_gc ,_dee :=ReadPNG (src );if _dee !=nil {return false ,"",0,0,_dee ;};_fad ,_dee :=ReadPNG (dst );if _dee !=nil {return false ,"",0,0,_dee ;};_bca :=_gc .Bounds ();_dcg :=_fad .Bounds ();
if !_ffc (_bca ,_dcg ){if _dc .Abs (float64 (_bca .Max .X )-float64 (_dcg .Max .X ))> 1{_de .Printf ("S\u006f\u0075\u0072\u0063\u0065\u0020b\u006f\u0075\u006e\u0064\u0073\u003a \u0025\u0076\u003b\u0020\u0044\u0065\u0073t\u0020\u0062\u006f\u0075\u006e\u0064\u0073\u003a\u0020\u0025v\u000a",_bca ,_dcg );
return false ,"",0,0,ErrImageSizeNotMatch ;};};_fcb :=_df .NewRGBA (_df .Rect (0,0,_bca .Max .X ,_bca .Max .Y ));var (_cde float64 ;_adfc float64 ;);for _ggf :=_bca .Min .Y ;_ggf < _bca .Max .Y ;_ggf ++{for _ddgg :=_bca .Min .X ;_ddgg < _bca .Max .X ;_ddgg ++{_efd ,_fbf ,_cdde ,_dcfg :=_gc .At (_ddgg ,_ggf ).RGBA ();
_eeda ,_edae ,_cega ,_bgbf :=_fad .At (_ddgg ,_ggf ).RGBA ();_fcb .Set (_ddgg ,_ggf ,_ag .RGBA {uint8 (_eeda ),uint8 (_edae ),uint8 (_cega ),64});_egc :=_dcfg ==0x00&&_efd ==0x00&&_fbf ==0x00&&_cdde ==0x00&&_eeda ==0xFFFF&&_edae ==0xFFFF&&_cega ==0xFFFF;
if !_egc &&!_aadb (_gc .At (_ddgg ,_ggf ),_fad .At (_ddgg ,_ggf )){_fcb .Set (_ddgg ,_ggf ,_ag .RGBA {uint8 (_efd ),uint8 (_fbf ),uint8 (_cdde ),uint8 (_dcfg )});_aege :=float64 (_efd )+float64 (_fbf )+float64 (_cdde )+float64 (_dcfg )-float64 (_eeda )+float64 (_edae )+float64 (_cega )+float64 (_bgbf );
_fcd :=_dc .Sqrt (_dc .Pow (_aege /float64 (_bca .Dx ()*_bca .Dy ()),2));_adfc +=_fcd ;_cde ++;};};};_fcg :=_cde /float64 (_bca .Dx ()*_bca .Dy ())*100;_dbgd :=_cc .Dir (src );_acg :=_d .TrimSuffix (_cc .Base (src ),_cc .Ext (src ));_bge ,_dee :=_gd .Create (_dbgd +"\u002f"+_acg +"\u002dd\u0069\u0066\u0066\u002e\u0070\u006eg");
if _dee !=nil {return false ,"",0,0,_dee ;};defer _bge .Close ();_gga :=_d .Replace (_dbgd ,"\u0072\u0065\u006e\u0064\u0065\u0072","\u0066\u006f\u006et\u0073",1)+"\u002f\u0043\u0061l\u0069\u0062\u0072\u0069\u002e\u0074\u0074\u0066";_bbd :=_deb .Sprintf ("\u0044\u0069f\u0066\u0065\u0072e\u006e\u0063\u0065\u003a\u0020\u0025\u0066\u0025\u0025",_fcg );
_dee =_cccc (_fcb ,_gga ,_bbd ,15,22);if _dee !=nil {return false ,"",0,0,_dee ;};_bbd =_deb .Sprintf ("T\u006ft\u0061\u006c\u0020\u0044\u0069\u0066\u0066\u0065r\u0065\u006e\u0063\u0065: \u0025\u0066",_adfc );_dee =_cccc (_fcb ,_gga ,_bbd ,15,44);if _dee !=nil {return false ,"",0,0,_dee ;
};if _ffe :=_ad .Encode (_bge ,_fcb );_ffe !=nil {return false ,"",0,0,_ffe ;};return true ,_bge .Name (),_fcg ,_adfc ,nil ;};func _eef (_cef string )error {_aeg :=_dfe .XSDAny {};_dda ,_aaa :=_gd .Open (_cef );if _aaa !=nil {return _aaa ;};_ddb :=_fe .NewDecoder (_dda );
if _aaa =_ddb .Decode (&_aeg );_aaa !=nil {return _aaa ;};_dda .Close ();_dda ,_aaa =_gd .Create (_cef );if _aaa !=nil {return _aaa ;};defer _dda .Close ();_afc :=_fe .NewEncoder (_dda );_afc .Indent ("","\u0020\u0020");return _afc .Encode (&_aeg );};func _aecc (_bdb *_b .T ,_cbe string )int64 {_cgde ,_eac :=_gd .Stat (_cbe );
_cb .NoError (_bdb ,_eac );return _cgde .Size ();};func _cccc (_gcb *_df .RGBA ,_cccd string ,_gfc string ,_gdf ,_gcg int )error {_abge ,_dga :=_ce .ReadFile (_cccd );if _dga !=nil {return _dga ;};_cae ,_dga :=_fdf .Parse (_abge );if _dga !=nil {return _dga ;
};_dgg ,_dga :=_fdf .NewFace (_cae ,&_fdf .FaceOptions {Size :18,DPI :72,Hinting :_cd .HintingNone });if _dga !=nil {return _dga ;};_bde :=&_cd .Drawer {Dst :_gcb ,Src :_df .NewUniform (_ag .RGBA {200,100,0,255}),Face :_dgg ,Dot :_ccc .P (_gdf ,_gcg )};
_bde .DrawString (_gfc );return nil ;};func (_daf *ReferenceMap )UnmarshalJSON (data []byte )error {return _da .Unmarshal (data ,&_daf ._bgf )};func CompareGoldenZip (t *_b .T ,expectedFn string ,got []byte ){_bad :=_cc .Join ("\u0074\u0065\u0073\u0074\u0064\u0061\u0074\u0061",expectedFn );
if *_ac {if _adg :=_gd .WriteFile (_bad ,got ,0644);_adg !=nil {t .Fatal (_adg );};};CompareZip (t ,expectedFn ,got ,true );};func ReadFile (dirPath ,testName string ,createEmpty bool )(*ReferenceFile ,error ){if dirPath ==""&&createEmpty {return &ReferenceFile {Map :&ReferenceMap {}},nil ;
};if dirPath ==""{return nil ,_gd .ErrNotExist ;};_gge :=_cc .Join (dirPath ,testName +"\u005fr\u0065f\u0065\u0072\u0065\u006e\u0063\u0065\u002e\u006a\u0073\u006f\u006e");_ceg :=&ReferenceFile {_bb :_gge };_cbb ,_ebf :=_gd .Open (_gge );if _g .Is (_ebf ,_gd .ErrNotExist )&&createEmpty {_ceg .Timestamp =_aa .Now ().UTC ();
_ceg .Map =&ReferenceMap {};return _ceg ,nil ;};if _ebf !=nil {return nil ,_ebf ;};defer _cbb .Close ();if _cee :=_da .NewDecoder (_cbb ).Decode (_ceg );_cee !=nil {if _cee .Error ()=="i\u006c\u006c\u0065\u0067\u0061\u006c \u0062\u0061\u0073\u0065\u0036\u0034 \u0064\u0061\u0074\u0061\u0020\u0061\u0074 \u0069\u006e\u0070\u0075\u0074\u0020\u0062\u0079\u0074\u0065 \u0030"&&createEmpty {return _ceg ,nil ;
};return nil ,_cee ;};return _ceg ,nil ;};func RunRenderTest (t *_b .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ){RunRenderOfficeTest (t ,pdfPath ,outputDir ,baselineRenderPath ,saveBaseline ,currentHashMap ,refFile ,"\u002em\u0073\u0077\u006f\u0072\u0064");
};type ReferenceFile struct{Timestamp _aa .Time `json:"timestamp"`;Map *ReferenceMap `json:"map,omitempty"`;_bb string ;};func RunRenderOfficeTest (t *_b .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ,currentHashMap *ReferenceMap ,refFile *ReferenceFile ,postfix string ){_aaf :=_d .TrimSuffix (_cc .Base (pdfPath ),_cc .Ext (pdfPath ));
t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_efb *_b .T ){_bgeb :=_cc .Join (outputDir ,_aaf );_gcbc :=_bgeb +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _afcb :=RenderPDFToPNGs (pdfPath ,0,_gcbc );_afcb !=nil {_efb .Skip (_afcb );};_dgad :=_aaf +postfix ;
_abb :=_cc .Join (outputDir ,_dgad );_fba :=_abb +"\u002d%\u0064\u002e\u0070\u006e\u0067";_aff :=false ;if saveBaseline {_fgcg :=_cc .Dir (pdfPath );_cbac :=_cc .Join (_fgcg ,_dgad +"\u002e\u0070\u0064\u0066");if _ ,_aebb :=_gd .Stat (_cbac );_aebb ==nil {_efb .Logf ("\u0052e\u006e\u0064\u0065\u0072\u0020\u004d\u0053\u0020\u004f\u0066\u0066i\u0063\u0065\u0020\u0050\u0044\u0046\u003a\u0020\u0025\u0076",_cbac );
if _dcgb :=RenderPDFToPNGs (_cbac ,0,_fba );_dcgb !=nil {_efb .Skip (_dcgb );};_aff =true ;};};for _degg :=1;true ;_degg ++{_ceca :=_deb .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_bgeb ,_degg );_bebb :=_cc .Join (baselineRenderPath ,_deb .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_aaf ,_degg ));
if _ ,_gdc :=_gd .Stat (_ceca );_gdc !=nil {break ;};_efb .Logf ("\u0025\u0073",_bebb );if saveBaseline {_efb .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_ceca ,_bebb );_ddec :=CopyFile (_ceca ,_bebb );
if _ddec !=nil {_efb .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_bebb ,_ddec );};if _aff {_cggb :=_deb .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_abb ,_degg );
_efcf :=_cc .Join (baselineRenderPath ,_deb .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_dgad ,_degg ));_efb .Logf ("\u0043\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u004d\u0053\u0020\u0057\u006f\u0072\u0064 \u0072e\u0073\u0075\u006c\u0074\u0073\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_cggb ,_efcf );
_bdec :=CopyFile (_cggb ,_efcf );if _bdec !=nil {_efb .Logf ("\u0045\u0052\u0052\u004f\u0052\u0020\u0063\u006f\u0070\u0079\u0069\u006eg\u0020\u0074\u006f \u0025\u0073\u003a\u0020\u0025\u0076\u002c\u0020\u0068\u0061\u0076i\u006e\u0067\u0020d\u0069\u0066\u0066\u0065r\u0065\u006e\u0074\u0020\u0070\u0061\u0067\u0065\u0020\u0073\u0069\u007a\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u002c\u0020\u0072\u0065\u0070\u006c\u0061\u0063\u0069\u006eg\u0020\u0069\u0074\u0020\u0077\u0069\u0074\u0068\u0020\u0062\u006ca\u006e\u006b\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0069\u006e\u0073\u0074\u0065\u0061\u0064",_efcf ,_bdec );
if _aegg :=_gbf (_bebb ,_efcf );_aegg !=nil {_efb .Fatalf ("\u0045\u0052\u0052\u004f\u0052\u0020c\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0065\u006d\u0070\u0074\u0079 \u0069\u006d\u0061\u0067\u0065\u0020\u0025s\u003a\u0020\u0025\u0076",_efcf ,_aegg );
};};_efb .Logf ("\u0043\u006fm\u0062\u0069\u006e\u0069\u006eg\u0020\u0055\u006e\u0069\u004ff\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_bebb ,_efcf );
_gdd ,_bdec :=CombinePNGFiles (_bebb ,_efcf );if _gd .IsNotExist (_bdec ){_efb .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_gdd {_efb .Fatal ("\u0055n\u0061\u0062\u006c\u0065\u0020\u0074\u006f\u0020\u0063\u006f\u006db\u0069\u006e\u0065\u0020\u0069\u006d\u0061\u0067\u0065\u0073");
};_efb .Logf ("\u0043\u0072\u0065\u0061\u0074\u0069\u006e\u0067\u0020\u0069\u006d\u0061\u0067\u0065\u0020\u0064\u0069\u0066f \u0055n\u0069\u004f\u0066\u0066\u0069\u0063\u0065\u0020\u0072\u0065\u0073\u0075l\u0074\u0073\u0020\u0077\u0069\u0074\u0068\u0020\u004d\u0053\u0020\u004f\u0066\u0066\u0069\u0063\u0065 \u0025\u0073\u0020\u0061\u006e\u0064\u0020\u0025\u0073",_bebb ,_efcf );
_gdd ,_gbd ,_eag ,_affd ,_bdec :=CreatePNGDiff (_bebb ,_efcf );if _bdec !=nil &&_g .Is (_bdec ,ErrImageSizeNotMatch ){_efb .Fatalf ("\u0045\u0072\u0072\u006fr\u0020\u006f\u006e\u0020\u0063\u0072\u0065\u0061\u0074\u0065 \u0050N\u0047\u0020\u0044\u0069\u0066\u0066\u003a \u0025\u0076",_bdec );
};if _gdd {_efb .Logf ("\u0049\u006d\u0061\u0067\u0065\u003a\u0020\u0025\u0073\u000a",_gbd );_efb .Logf ("D\u0069\u0066\u0066\u0020Pe\u0072c\u0065\u006e\u0074\u003a\u0020%\u0032\u002e\u0066\u0025\u0025\u000a",_eag );_efb .Logf ("\u0044i\u0066f\u0020\u0054\u006f\u0074\u0061\u006c\u003a\u0020\u0025\u0066\u000a",_affd );
_bbg :=_cc .Base (_gbd );_abdc ,_gae :=currentHashMap .Read (_bbg );if _gae &&(_abdc .DiffPercent < _eag ||_abdc .DiffTotal < _affd ){_efb .Logf ("\u004e\u0065\u0077\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u0068\u0061\u0076\u0069\u006e\u0067 h\u0069g\u0068\u0065\u0072\u0020\u0064\u0069\u0066\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0070\u0065\u0072\u0063\u0065\u006e\u0074\u003a\u0020\u0025\u0066\u0020\u0061\u006e\u0064 \u0074\u006f\u0074\u0061\u006c\u0020\u0025\u0066\u000a",_eag ,_affd );
};_fadc ,_fgb :=HashFile (_gbd );_cb .NoError (_efb ,_fgb );_egcc :=_aecc (_efb ,_gbd );if !_gae ||_abdc .Value !=_fadc ||_abdc .ResultSize !=_egcc ||_abdc .DiffPercent !=_eag ||_abdc .DiffTotal !=_affd {_dabc :=ReferenceEntry {Timestamp :_aa .Now ().UTC ().Unix (),Value :_fadc ,ResultSize :_egcc ,DiffPercent :_eag ,DiffTotal :_affd };
currentHashMap .Write (_bbg ,_dabc );if _fgb =refFile .Update (currentHashMap );_fgb !=nil {_efb .Logf ("\u0055\u0070\u0064\u0061\u0074\u0065\u0020\u0072\u0065\u0066\u0065\u0072\u0065\u006e\u0063e\u0020f\u0069\u006c\u0065\u0020\u0066\u0061\u0069\u006c\u0065\u0064\u003a\u0020\u0025\u0076",_fgb );
};};};};continue ;};_efb .Run (_deb .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_degg ),func (_dabe *_b .T ){_dabe .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_ceca ,_bebb );_agf ,_bee :=ComparePNGFiles (_ceca ,_bebb );
if _gd .IsNotExist (_bee ){_dabe .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_agf {_dabe .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func ReadPNG (file string )(_df .Image ,error ){_ceb ,_ebb :=_gd .Open (file );if _ebb !=nil {return nil ,_ebb ;};defer _ceb .Close ();return _ad .Decode (_ceb );};type ValidationResult struct{File string `json:"file"`;Result bool `json:"result"`;
Note string `json:"note"`;};func (_ebg *ReferenceMap )Copy ()*ReferenceMap {_ggc :=ReferenceMap {_bgf :make (map[string ]ReferenceEntry ,len (_ebg ._bgf ))};for _edca ,_afg :=range _ebg ._bgf {_ggc ._bgf [_edca ]=_afg ;};return &_ggc ;};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;
};if _ ,_bff :=_fd .LookPath ("\u0067\u0073");_bff !=nil {return ErrRenderNotSupported ;};return _fd .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_deb .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};